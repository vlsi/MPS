package jetbrains.mps.baseLanguage.actions;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.baseLanguage.behavior.IContainsStatementList_Behavior;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.typesystem.inference.TypeChecker;
import jetbrains.mps.smodel.action.SNodeFactoryOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.smodel.SModelUtil_new;
import jetbrains.mps.smodel.SReference;

public class AlterStatementListContainerFactoryUtils {
  private static boolean hasCondition(SNode node) {
    return SNodeOperations.isInstanceOf(node, "jetbrains.mps.baseLanguage.structure.IfStatement") || SNodeOperations.isInstanceOf(node, "jetbrains.mps.baseLanguage.structure.WhileStatement") || SNodeOperations.isInstanceOf(node, "jetbrains.mps.baseLanguage.structure.DoWhileStatement");
  }

  private static SNode getCondition(SNode node) {
    assert hasCondition(node);
    return SNodeOperations.cast(ListSequence.fromList(SNodeOperations.getChildren(node)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.baseLanguage.structure.Expression");
      }
    }).first(), "jetbrains.mps.baseLanguage.structure.Expression");
  }

  private static void buildContainer(SNode sampleNode, final SNode newNode) {
    ListSequence.fromList(SLinkOperations.getTargets(IContainsStatementList_Behavior.call_getStatementList_1237545932619(sampleNode), "statement", true)).visitAll(new IVisitor<SNode>() {
      public void visit(SNode it) {
        ListSequence.fromList(SLinkOperations.getTargets(IContainsStatementList_Behavior.call_getStatementList_1237545932619(newNode), "statement", true)).addElement(it);
      }
    });
    if (hasCondition(sampleNode) && hasCondition(newNode)) {
      SNode originalCondition = getCondition(sampleNode);
      if (originalCondition != null) {
        SNodeOperations.replaceWithAnother(getCondition(newNode), SNodeOperations.copyNode(originalCondition));
      }
    }
    if (SNodeOperations.isInstanceOf(newNode, "jetbrains.mps.baseLanguage.structure.ForStatement")) {
      SNode inputSequence;
      final Wrappers._T<SNode> loopVariable = new Wrappers._T<SNode>();
      SNode varType;
      SNode collectionType;
      if (SNodeOperations.isInstanceOf(sampleNode, "jetbrains.mps.baseLanguage.structure.ForeachStatement")) {
        inputSequence = SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.structure.ForeachStatement"), "iterable", true);
        loopVariable.value = SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.structure.ForeachStatement"), "variable", true);
        varType = SLinkOperations.getTarget(SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.structure.ForeachStatement"), "variable", true), "type", true);
        collectionType = TypeChecker.getInstance().getTypeOf(SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.structure.ForeachStatement"), "iterable", true));
      } else if (SNodeOperations.isInstanceOf(sampleNode, "jetbrains.mps.baseLanguage.collections.structure.ForEachStatement")) {
        inputSequence = SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.collections.structure.ForEachStatement"), "inputSequence", true);
        loopVariable.value = SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.collections.structure.ForEachStatement"), "variable", true);
        varType = SNodeOperations.cast(TypeChecker.getInstance().getTypeOf(SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.collections.structure.ForEachStatement"), "variable", true)), "jetbrains.mps.baseLanguage.structure.Type");
        collectionType = TypeChecker.getInstance().getTypeOf(SLinkOperations.getTarget(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.collections.structure.ForEachStatement"), "inputSequence", true));
      } else {
        return;
      }
      SNode forStatement = SNodeOperations.cast(newNode, "jetbrains.mps.baseLanguage.structure.ForStatement");
      SNode iteratorVar = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.structure.LocalVariableDeclaration", null);

      SNode inputSequenceDeclaration;
      if (SNodeOperations.isInstanceOf(inputSequence, "jetbrains.mps.baseLanguage.structure.VariableReference")) {
        inputSequenceDeclaration = SLinkOperations.getTarget(SNodeOperations.cast(inputSequence, "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", false);
      } else {
        inputSequenceDeclaration = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.structure.LocalVariableDeclaration", null);
        SLinkOperations.setTarget(inputSequenceDeclaration, "type", TypeChecker.getInstance().getTypeOf(inputSequence), true);
        SPropertyOperations.set(inputSequenceDeclaration, "name", "inputCollection");
        SLinkOperations.setTarget(inputSequenceDeclaration, "initializer", SNodeOperations.copyNode(inputSequence), true);
        SNode v = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.structure.LocalVariableDeclarationStatement", null);
        SLinkOperations.setTarget(v, "localVariableDeclaration", inputSequenceDeclaration, true);
        SNodeOperations.insertPrevSiblingChild(sampleNode, v);
      }
      if (SNodeOperations.isInstanceOf(collectionType, "jetbrains.mps.baseLanguage.structure.ArrayType")) {
        SPropertyOperations.set(iteratorVar, "name", "index");
        SLinkOperations.setTarget(iteratorVar, "initializer", createIntegerConstant_kz5t2g_a0a1a01a2a4(), true);
        SLinkOperations.setTarget(iteratorVar, "type", createIntegerType_kz5t2g_a0a2a01a2a4(), true);
        SLinkOperations.setTarget(forStatement, "variable", iteratorVar, true);
        SLinkOperations.setTarget(forStatement, "condition", createLessThanExpression_kz5t2g_a0a4a01a2a4(), true);
        ListSequence.fromList(SLinkOperations.getTargets(forStatement, "iteration", true)).addElement(createPostfixIncrementExpression_kz5t2g_a0a5a01a2a4());
        SNode cond = SNodeOperations.cast(SLinkOperations.getTarget(forStatement, "condition", true), "jetbrains.mps.baseLanguage.structure.LessThanExpression");
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(cond, "leftExpression", true), "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", iteratorVar, false);
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(cond, "rightExpression", true), "jetbrains.mps.baseLanguage.structure.DotExpression"), "operand", true), "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", inputSequenceDeclaration, false);
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(forStatement, "iteration", true)).first(), "jetbrains.mps.baseLanguage.structure.PostfixIncrementExpression"), "expression", true), "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", iteratorVar, false);

        final SNode a = createArrayAccessExpression_kz5t2g_a0l0k0c0e();
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(a, "array", true), "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", inputSequenceDeclaration, false);
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(a, "index", true), "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", iteratorVar, false);
        ListSequence.fromList(SNodeOperations.getDescendants(SLinkOperations.getTarget(forStatement, "body", true), "jetbrains.mps.baseLanguage.structure.VariableReference", false, new String[]{})).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return SLinkOperations.getTarget(it, "variableDeclaration", false) == loopVariable.value;
          }
        }).visitAll(new IVisitor<SNode>() {
          public void visit(SNode it) {
            SNodeOperations.replaceWithAnother(it, SNodeOperations.copyNode(a));
          }
        });
        ListSequence.fromList(SNodeOperations.getDescendants(SLinkOperations.getTarget(forStatement, "body", true), "jetbrains.mps.baseLanguage.collections.structure.ForEachVariableReference", false, new String[]{})).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return SLinkOperations.getTarget(it, "variable", false) == loopVariable.value;
          }
        }).visitAll(new IVisitor<SNode>() {
          public void visit(SNode it) {
            SNodeOperations.replaceWithAnother(it, SNodeOperations.copyNode(a));
          }
        });

      } else {
        SPropertyOperations.set(iteratorVar, "name", "loopIterator");
        SLinkOperations.setTarget(iteratorVar, "initializer", createDotExpression_kz5t2g_a0a1a0k0c0e(), true);
        SNode r = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.structure.VariableReference", null);
        SLinkOperations.setTarget(r, "variableDeclaration", inputSequenceDeclaration, false);
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(iteratorVar, "initializer", true), "jetbrains.mps.baseLanguage.structure.DotExpression"), "operand", r, true);
        SNode f = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.structure.ClassifierType", null);
        SLinkOperations.setTarget(f, "classifier", SNodeOperations.getNode("6354ebe7-c22a-4a0f-ac54-50b52ab9b065/f:java_stub#6354ebe7-c22a-4a0f-ac54-50b52ab9b065#java.util(JDK/java.util@java_stub)", "~Iterator"), false);
        SLinkOperations.setTarget(iteratorVar, "type", f, true);
        ListSequence.fromList(SLinkOperations.getTargets(SNodeOperations.cast(SLinkOperations.getTarget(iteratorVar, "type", true), "jetbrains.mps.baseLanguage.structure.ClassifierType"), "parameter", true)).addElement(BehaviorReflection.invokeVirtual((Class<SNode>) ((Class) Object.class), varType, "virtual_getBoxedType_1213877337320", new Object[]{}));
        SLinkOperations.setTarget(forStatement, "variable", iteratorVar, true);

        SLinkOperations.setTarget(forStatement, "condition", createDotExpression_kz5t2g_a0a11a0k0c0e(), true);
        SLinkOperations.setTarget(SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(forStatement, "condition", true), "jetbrains.mps.baseLanguage.structure.DotExpression"), "operand", SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.structure.VariableReference", null), true), "variableDeclaration", iteratorVar, false);

        final SNode vd = SNodeFactoryOperations.createNewNode("jetbrains.mps.baseLanguage.structure.LocalVariableDeclarationStatement", null);
        SPropertyOperations.set(SLinkOperations.getTarget(vd, "localVariableDeclaration", true), "name", "localLoopVariable");
        SLinkOperations.setTarget(SLinkOperations.getTarget(vd, "localVariableDeclaration", true), "type", TypeChecker.getInstance().getTypeOf(loopVariable.value), true);
        SLinkOperations.setTarget(SLinkOperations.getTarget(vd, "localVariableDeclaration", true), "initializer", createDotExpression_kz5t2g_a0a71a0k0c0e(), true);
        SLinkOperations.setTarget(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(SLinkOperations.getTarget(vd, "localVariableDeclaration", true), "initializer", true), "jetbrains.mps.baseLanguage.structure.DotExpression"), "operand", true), "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", iteratorVar, false);
        ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(forStatement, "body", true), "statement", true)).insertElement(0, vd);

        ListSequence.fromList(SNodeOperations.getDescendants(SLinkOperations.getTarget(forStatement, "body", true), "jetbrains.mps.baseLanguage.structure.VariableReference", false, new String[]{})).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return SLinkOperations.getTarget(it, "variableDeclaration", false) == loopVariable.value;
          }
        }).visitAll(new IVisitor<SNode>() {
          public void visit(SNode it) {
            SLinkOperations.setTarget(it, "variableDeclaration", SLinkOperations.getTarget(vd, "localVariableDeclaration", true), false);
          }
        });
        ListSequence.fromList(SNodeOperations.getDescendants(SLinkOperations.getTarget(forStatement, "body", true), "jetbrains.mps.baseLanguage.collections.structure.ForEachVariableReference", false, new String[]{})).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return SLinkOperations.getTarget(it, "variable", false) == loopVariable.value;
          }
        }).visitAll(new IVisitor<SNode>() {
          public void visit(SNode it) {
            SLinkOperations.setTarget(SNodeFactoryOperations.replaceWithNewChild(it, "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", SLinkOperations.getTarget(vd, "localVariableDeclaration", true), false);
          }
        });
      }
    }
  }
  public static void buildContainerIfPossible(SNode sampleNode, SNode newNode) {
    if (SNodeOperations.isInstanceOf(sampleNode, "jetbrains.mps.baseLanguage.structure.IContainsStatementList")) {
      buildContainer(SNodeOperations.cast(sampleNode, "jetbrains.mps.baseLanguage.structure.IContainsStatementList"), newNode);
    }
  }
  private static SNode createIntegerConstant_kz5t2g_a0a1a01a2a4() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.IntegerConstant", null, false);
    n1.setProperty("value", "" + 0);
    return n1;
  }
  private static SNode createIntegerType_kz5t2g_a0a2a01a2a4() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.IntegerType", null, false);
    return n1;
  }
  private static SNode createLessThanExpression_kz5t2g_a0a4a01a2a4() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.LessThanExpression", null, false);
    {
      SNode n2 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
      SNode n3 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.DotExpression", null, false);
      {
        SNode n4 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
        SNode n5 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.ArrayLengthOperation", null, false);
        n3.addChild("operand", n4);
        n3.addChild("operation", n5);
      }
      n1.addChild("leftExpression", n2);
      n1.addChild("rightExpression", n3);
    }
    return n1;
  }
  private static SNode createPostfixIncrementExpression_kz5t2g_a0a5a01a2a4() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.PostfixIncrementExpression", null, false);
    {
      SNode n2 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
      n1.addChild("expression", n2);
    }
    return n1;
  }
  private static SNode createArrayAccessExpression_kz5t2g_a0l0k0c0e() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.ArrayAccessExpression", null, false);
    {
      SNode n2 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
      SNode n3 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
      n1.addChild("array", n2);
      n1.addChild("index", n3);
    }
    return n1;
  }
  private static SNode createDotExpression_kz5t2g_a0a1a0k0c0e() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.DotExpression", null, false);
    {
      SNode n2 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
      SNode n3 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.collections.structure.GetIteratorOperation", null, false);
      n1.addChild("operand", n2);
      n1.addChild("operation", n3);
    }
    return n1;
  }
  private static SNode createDotExpression_kz5t2g_a0a11a0k0c0e() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.DotExpression", null, false);
    {
      SNode n2 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
      SNode n3 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.InstanceMethodCallOperation", null, false);
      n3.setReference("baseMethodDeclaration", SReference.create("baseMethodDeclaration", n3, facade.createModelReference("6354ebe7-c22a-4a0f-ac54-50b52ab9b065/f:java_stub#6354ebe7-c22a-4a0f-ac54-50b52ab9b065#java.util(JDK/java.util@java_stub)"), facade.createNodeId("~Iterator.hasNext():boolean")));
      n1.addChild("operand", n2);
      n1.addChild("operation", n3);
    }
    return n1;
  }
  private static SNode createDotExpression_kz5t2g_a0a71a0k0c0e() {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.DotExpression", null, false);
    {
      SNode n2 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.VariableReference", null, false);
      SNode n3 = SModelUtil_new.instantiateConceptDeclaration("jetbrains.mps.baseLanguage.structure.InstanceMethodCallOperation", null, false);
      n3.setReference("baseMethodDeclaration", SReference.create("baseMethodDeclaration", n3, facade.createModelReference("6354ebe7-c22a-4a0f-ac54-50b52ab9b065/f:java_stub#6354ebe7-c22a-4a0f-ac54-50b52ab9b065#java.util(JDK/java.util@java_stub)"), facade.createNodeId("~Iterator.next():java.lang.Object")));
      n1.addChild("operand", n2);
      n1.addChild("operation", n3);
    }
    return n1;
  }
}

package jetbrains.mps.lang.plugin.scripts;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.project.IModule;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.project.ModuleId;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.model.SReference;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.SModelReference;
import java.util.List;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.SModelRepository;
import java.util.Collection;
import jetbrains.mps.project.structure.modules.Dependency;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;

/*package*/ class MpsClasspathRefUtil {
  private MpsClasspathRefUtil() {
  }

  /*package*/ static void updateReferencesToMpsClasspath(SNode node) {
    IModule[] modules = {MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("6354ebe7-c22a-4a0f-ac54-50b52ab9b065")), MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("3f233e7f-b8a6-46d2-a57f-795d56775243")), MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("8865b7a8-5271-43d3-884c-6fd1d9cfdd34")), MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("6ed54515-acc8-4d1e-a16c-9fd6cfe951ea")), MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("1ed103c3-3aa6-49b7-9c21-6765ee11f224")), MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("742f6602-5a2f-4313-aa6e-ae1cd4ffdc61")), MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("86441d7a-e194-42da-81a5-2161ec62a379"))};

    SModel model = SNodeOperations.getModel(node);
    IModule module = check_xpwqv8_a0d0b(model.getModelDescriptor());

    for (SReference ref : Sequence.fromIterable(SNodeOperations.getReferences(node))) {
      SModelReference oldModelRef = ref.getTargetSModelReference();
      final String fqname = check_xpwqv8_a0b0f0b(oldModelRef);
      for (IModule newModule : modules) {
        if (newModule == null) {
          continue;
        }
        List<SModelDescriptor> models = newModule.getOwnModelDescriptors();
        SModelReference modelRef = check_xpwqv8_a0c0c0f0b(ListSequence.fromList(models).findFirst(new IWhereFilter<SModelDescriptor>() {
          public boolean accept(SModelDescriptor it) {
            return eq_xpwqv8_a0a0a0a0a0a0c0c0f0b(it.getLongName(), fqname);
          }
        }));
        if (modelRef == null) {
          continue;
        }
        if (modelRef.equals(oldModelRef)) {
          break;
        }
        ref.setTargetSModelReference(modelRef);
        // check reference - sometimes same package can be in several modules 
        if ((SLinkOperations.getTargetNode(ref) == null)) {
          ref.setTargetSModelReference(oldModelRef);
          continue;
        }
        model.addModelImport(modelRef, false);
        model.deleteModelImport(oldModelRef);
        SModelRepository.getInstance().markChanged(model);
        // update module dependencies 
        if (module != null && module.getModuleDescriptor() != null) {
          Collection<Dependency> dependencies = module.getModuleDescriptor().getDependencies();
          Dependency dep = CollectionSequence.fromCollection(((Collection<Dependency>) dependencies)).findFirst(new IWhereFilter<Dependency>() {
            public boolean accept(Dependency it) {
              return it.getModuleRef().getModuleFqName().contains("MPS.Classpath");
            }
          });
          // get re-export from MPS.Classpath, then should be checked manually 
          module.addDependency(newModule.getModuleReference(), dep != null && dep.isReexport());
          if (dep != null) {
            dependencies.remove(dep);
          }
        }
        break;
      }
    }
  }

  private static IModule check_xpwqv8_a0d0b(SModelDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModule();
    }
    return null;
  }

  private static String check_xpwqv8_a0b0f0b(SModelReference checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLongName();
    }
    return null;
  }

  private static SModelReference check_xpwqv8_a0c0c0f0b(SModelDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSModelReference();
    }
    return null;
  }

  private static boolean eq_xpwqv8_a0a0a0a0a0a0c0c0f0b(Object a, Object b) {
    return (a != null ?
      a.equals(b) :
      a == b
    );
  }
}

package jetbrains.mps.lang.structure.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.refactoring.framework.IRefactoring;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.refactoring.framework.RefactoringUtil;
import jetbrains.mps.lang.core.behavior.INamedConcept_Behavior;
import jetbrains.mps.refactoring.framework.RefactoringContext;
import jetbrains.mps.ide.platform.refactoring.RefactoringAccess;
import jetbrains.mps.nodeEditor.EditorContext;
import javax.swing.JOptionPane;

public class CommitUtil {
  public static void refactorRenameNode(final IOperationContext context, final SNode node, String newName) {
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        SModelRepository.getInstance().saveAll();
      }
    });
    final Wrappers._T<IRefactoring> refactoring = new Wrappers._T<IRefactoring>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        SNode refactoringNode = (SNodeOperations.isInstanceOf(node, "jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration") ?
          SNodeOperations.getNode("r:de5b7214-45ee-4f6d-89bf-acde59cdb050(jetbrains.mps.lang.structure.refactorings)", "1347577327951781517") :
          (SNodeOperations.isInstanceOf(node, "jetbrains.mps.lang.structure.structure.PropertyDeclaration") ?
            SNodeOperations.getNode("r:de5b7214-45ee-4f6d-89bf-acde59cdb050(jetbrains.mps.lang.structure.refactorings)", "1347577327951781764") :
            (SNodeOperations.isInstanceOf(node, "jetbrains.mps.lang.structure.structure.LinkDeclaration") ?
              SNodeOperations.getNode("r:de5b7214-45ee-4f6d-89bf-acde59cdb050(jetbrains.mps.lang.structure.refactorings)", "1347577327951781638") :
              null
            )
          )
        );
        refactoring.value = (refactoringNode != null ?
          RefactoringUtil.getRefactoringByClassName(INamedConcept_Behavior.call_getFqName_1213877404258(refactoringNode)) :
          null
        );
      }
    });
    if (refactoring.value == null) {
      return;
    }

    final RefactoringContext refactoringContext = new RefactoringContext(refactoring.value);
    refactoringContext.setCurrentOperationContext(context);
    refactoringContext.setSelectedNode(node);
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        refactoringContext.setSelectedModel(SNodeOperations.getModel(node).getModelDescriptor());
      }
    });
    refactoringContext.setSelectedModule(context.getModule());
    refactoringContext.setSelectedProject(context.getProject());

    // set new name parameter for refactoring to skip initial dialog 
    refactoringContext.setParameter("newName", newName);
    final IRefactoring fRefactoring = refactoring.value;
    new Thread() {
      public void run() {
        refactoringContext.setRefactoring(refactoring.value);
        RefactoringAccess.getInstance().getRefactoringFacade().execute(refactoringContext);
      }
    }.start();
  }

  public static boolean commitRename(EditorContext editorContext, SNode node, String oldValue, String newValue) {
    if (oldValue == null) {
      return false;
    }
    if (oldValue.equals(newValue)) {
      return true;
    }
    int res = JOptionPane.showConfirmDialog(editorContext.getNodeEditorComponent(), "Renaming " + "this element" + " can break your model. It is advised to use refactoring for this. Execute refactoring?", "Rename " + "element", JOptionPane.YES_NO_CANCEL_OPTION);
    if (res == JOptionPane.YES_OPTION) {
      refactorRenameNode(editorContext.getOperationContext(), node, newValue);
    }
    return (res != JOptionPane.NO_OPTION && res != JOptionPane.CLOSED_OPTION);
  }
}

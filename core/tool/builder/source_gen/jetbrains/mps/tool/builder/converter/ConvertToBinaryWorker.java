package jetbrains.mps.tool.builder.converter;

/*Generated by MPS */

import java.util.Map;
import jetbrains.mps.MPSCore;
import jetbrains.mps.persistence.MPSPersistence;
import jetbrains.mps.RuntimeFlags;
import jetbrains.mps.persistence.PersistenceRegistry;
import jetbrains.mps.persistence.LightModelEnvironmentInfoImpl;
import jetbrains.mps.smodel.ModelAccess;
import java.io.IOException;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.vfs.FileSystem;
import org.jetbrains.mps.openapi.persistence.ModelFactory;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.util.FileUtil;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.extapi.persistence.FileDataSource;
import java.util.Collections;
import jetbrains.mps.persistence.DefaultModelPersistence;
import jetbrains.mps.project.MPSExtentions;
import org.jetbrains.mps.openapi.persistence.ModelSaveException;

public class ConvertToBinaryWorker {
  public ConvertToBinaryWorker() {
  }
  public void convert(final Map<String, String> map, final Boolean stripImplementation) {
    final MPSCore mpsCore = new MPSCore();
    mpsCore.init();
    final MPSPersistence mpsPersistence = new MPSPersistence();
    mpsPersistence.init();
    RuntimeFlags.setMergeDriverMode(true);
    PersistenceRegistry.getInstance().setModelEnvironmentInfo(new LightModelEnvironmentInfoImpl());
    RuntimeFlags.setPlayRefactoringsMode(false);
    try {
      ModelAccess.instance().runWriteAction(new Runnable() {
        public void run() {
          try {
            for (Map.Entry<String, String> entry : map.entrySet()) {
              convertModelToBinary(entry.getKey(), entry.getValue(), stripImplementation);
            }
          } catch (IOException ex) {
            throw new RuntimeException(ex);
          }
        }
      });
    } finally {
      PersistenceRegistry.getInstance().setModelEnvironmentInfo(null);
      mpsPersistence.dispose();
      mpsCore.dispose();
    }
  }
  private void convertModelToBinary(String sourceFile, String destFile, boolean stripImplementation) throws IOException {
    IFile source = FileSystem.getInstance().getFileByPath(sourceFile);
    ModelFactory modelFactory = PersistenceFacade.getInstance().getModelFactory(FileUtil.getExtension(source.getName()));
    if (modelFactory == null) {
      // assuming user knows what he's doing and supplied us with a model file, try default factory. 
      modelFactory = PersistenceFacade.getInstance().getDefaultModelFactory();
    }
    try {
      SModel model = modelFactory.load(new FileDataSource(source), Collections.singletonMap(DefaultModelPersistence.OPTION_STRIP_IMPLEMENTATION, Boolean.toString(stripImplementation)));
      PersistenceFacade.getInstance().getModelFactory(MPSExtentions.MODEL_BINARY).save(model, new FileDataSource(FileSystem.getInstance().getFileByPath(destFile)));
    } catch (ModelSaveException e) {
      throw new IOException(String.format("Failed to write model in binary format to file %s", destFile), e);
    }
  }
}

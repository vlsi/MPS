package jetbrains.mps.project.persistence;

/*Generated by MPS */

import jetbrains.mps.project.structure.modules.DeploymentDescriptor;
import jetbrains.mps.vfs.IFile;
import org.jdom.Document;
import jetbrains.mps.util.JDOMUtil;
import org.jdom.Element;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.util.xml.XmlUtil;
import jetbrains.mps.project.structure.modules.Dependency;
import jetbrains.mps.project.structure.modules.ModuleReference;

public class DeploymentDescriptorPersistence {
  public DeploymentDescriptorPersistence() {
  }

  public static DeploymentDescriptor loadDeploymentDescriptor(final IFile file) {
    DeploymentDescriptor descriptor;

    try {
      Document document = JDOMUtil.loadDocument(file);
      final Element rootElement = document.getRootElement();

      descriptor = new _FunctionTypes._return_P0_E0<DeploymentDescriptor>() {
        public DeploymentDescriptor invoke() {
          final DeploymentDescriptor result_wu2j1h_a0a0d0c0a = new DeploymentDescriptor();
          final String result_wu2j1h_a0a0a0d0c0a = rootElement.getAttributeValue("namespace");
          result_wu2j1h_a0a0d0c0a.setNamespace(result_wu2j1h_a0a0a0d0c0a);
          final String result_wu2j1h_a1a0a0d0c0a = rootElement.getAttributeValue("uuid");
          result_wu2j1h_a0a0d0c0a.setUUID(result_wu2j1h_a1a0a0d0c0a);
          final String result_wu2j1h_a2a0a0d0c0a = rootElement.getAttributeValue("type");
          result_wu2j1h_a0a0d0c0a.setType(result_wu2j1h_a2a0a0d0c0a);

          for (Element a : Sequence.fromIterable(XmlUtil.children(rootElement, "dependencies"))) {
            for (final Element module : Sequence.fromIterable(XmlUtil.children(a, "module"))) {
              result_wu2j1h_a0a0d0c0a.getDependencies().add(new _FunctionTypes._return_P0_E0<Dependency>() {
                public Dependency invoke() {
                  final Dependency result_wu2j1h_a0a0a0a0a4a0a0d0c0a = new Dependency();
                  final ModuleReference result_wu2j1h_a0a0a0a0a0a4a0a0d0c0a = ModuleReference.fromString(module.getAttributeValue("ref"));
                  result_wu2j1h_a0a0a0a0a4a0a0d0c0a.setModuleRef(result_wu2j1h_a0a0a0a0a0a4a0a0d0c0a);
                  final boolean result_wu2j1h_a1a0a0a0a0a4a0a0d0c0a = false;
                  result_wu2j1h_a0a0a0a0a4a0a0d0c0a.setReexport(result_wu2j1h_a1a0a0a0a0a4a0a0d0c0a);
                  return result_wu2j1h_a0a0a0a0a4a0a0d0c0a;
                }
              }.invoke());
            }
          }

          for (Element b : Sequence.fromIterable(XmlUtil.children(rootElement, "runtime"))) {
            result_wu2j1h_a0a0d0c0a.getRuntimeJars().add(b.getAttributeValue("jar"));
          }
          for (Element b : Sequence.fromIterable(XmlUtil.children(rootElement, "library"))) {
            result_wu2j1h_a0a0d0c0a.getLibraries().add(b.getAttributeValue("jar"));
          }

          Element sources = XmlUtil.first(rootElement, "sources");
          if (sources != null) {
            final String result_wu2j1h_a0a01a0a0d0c0a = sources.getAttributeValue("jar");
            result_wu2j1h_a0a0d0c0a.setSourcesJar(result_wu2j1h_a0a01a0a0d0c0a);
            final String result_wu2j1h_a1a01a0a0d0c0a = sources.getAttributeValue("descriptor");
            result_wu2j1h_a0a0d0c0a.setDescriptorFile(result_wu2j1h_a1a01a0a0d0c0a);
          }

          return result_wu2j1h_a0a0d0c0a;
        }
      }.invoke();
    } catch (Exception e) {
      throw new ModuleReadException(e);
    }

    ModuleDescriptorPersistence.setTimestamp(descriptor, file);
    return descriptor;
  }
}

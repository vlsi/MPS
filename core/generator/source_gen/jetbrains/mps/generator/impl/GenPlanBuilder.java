package jetbrains.mps.generator.impl;

/*Generated by MPS */

import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.generator.ModelGenerationPlan;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.generator.runtime.TemplateMappingConfiguration;
import jetbrains.mps.smodel.language.LanguageRuntime;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.smodel.behaviour.BHReflection;
import jetbrains.mps.core.aspects.behaviour.SMethodTrimmedId;
import jetbrains.mps.smodel.language.GeneratorRuntime;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.module.SModuleReference;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.generator.RigidGenerationPlan;
import jetbrains.mps.generator.runtime.TemplateModule;
import jetbrains.mps.generator.runtime.TemplateModel;

public class GenPlanBuilder {
  private final LanguageRegistry myLanguageRegistry;

  public GenPlanBuilder(LanguageRegistry languageRegistry) {
    myLanguageRegistry = languageRegistry;
  }

  public ModelGenerationPlan create(SNode plan) {
    List<ModelGenerationPlan.Step> steps = new ArrayList<ModelGenerationPlan.Step>();
    for (SNode stepNode : SLinkOperations.getChildren(plan, MetaAdapterFactory.getContainmentLink(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x19443180a20717fbL, 0x19443180a2071807L, "steps"))) {
      if (SNodeOperations.isInstanceOf(stepNode, MetaAdapterFactory.getConcept(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x19443180a2071801L, "jetbrains.mps.lang.generator.plan.structure.Checkpoint"))) {
        steps.add(new ModelGenerationPlan.Checkpoint(SPropertyOperations.getString(SNodeOperations.as(stepNode, MetaAdapterFactory.getConcept(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x19443180a2071801L, "jetbrains.mps.lang.generator.plan.structure.Checkpoint")), MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name"))));
      } else if (SNodeOperations.isInstanceOf(stepNode, MetaAdapterFactory.getConcept(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x19443180a2071802L, "jetbrains.mps.lang.generator.plan.structure.Transform"))) {
        SNode trStep = SNodeOperations.as(stepNode, MetaAdapterFactory.getConcept(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x19443180a2071802L, "jetbrains.mps.lang.generator.plan.structure.Transform"));
        ArrayList<TemplateMappingConfiguration> mc = new ArrayList<TemplateMappingConfiguration>();
        for (SNode lid : SLinkOperations.getChildren(trStep, MetaAdapterFactory.getContainmentLink(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x19443180a2071802L, 0x28dd6d5a7549fa8dL, "languages"))) {
          LanguageRuntime lr = myLanguageRegistry.getLanguage(((SLanguage) BHReflection.invoke(lid, SMethodTrimmedId.create("getLanguage", null, "34EJa6aIcyj"))));
          if (lr == null) {
            continue;
          }
          for (GeneratorRuntime gr : lr.getGenerators()) {
            fillMC(gr, mc);
          }
        }
        steps.add(new ModelGenerationPlan.Transform(mc));
      } else if (SNodeOperations.isInstanceOf(stepNode, MetaAdapterFactory.getConcept(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x73246de9adeca171L, "jetbrains.mps.lang.generator.plan.structure.ApplyGenerators"))) {
        SRepository repository = SNodeOperations.getModel(plan).getRepository();
        ArrayList<TemplateMappingConfiguration> mc = new ArrayList<TemplateMappingConfiguration>();
        for (SNode generator : Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(SNodeOperations.as(stepNode, MetaAdapterFactory.getConcept(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x73246de9adeca171L, "jetbrains.mps.lang.generator.plan.structure.ApplyGenerators")), MetaAdapterFactory.getContainmentLink(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x73246de9adeca171L, 0x73246de9adf5a45cL, "generator")), MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x73246de9adecb80dL, "jetbrains.mps.lang.smodel.structure.GeneratorModulePointer")))) {
          SModuleReference mr = ((SModuleReference) BHReflection.invoke(SLinkOperations.getTarget(generator, MetaAdapterFactory.getContainmentLink(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x73246de9adecb80dL, 0x73246de9adecb874L, "module")), SMethodTrimmedId.create("getModuleReference", null, "nJmxU5cSSU")));
          SModule module = (mr == null ? null : mr.resolve(repository));
          if (!(module instanceof Generator)) {
            continue;
          }
          GeneratorRuntime gr = myLanguageRegistry.getGenerator((Generator) module);
          fillMC(gr, mc);
        }
        steps.add(new ModelGenerationPlan.Transform(mc));
      }
    }
    return new RigidGenerationPlan(SPropertyOperations.getString(plan, MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name")), steps);
  }

  private static void fillMC(GeneratorRuntime gr, List<TemplateMappingConfiguration> mc) {
    if (!(gr instanceof TemplateModule)) {
      return;
    }
    for (TemplateModel tm : ((TemplateModule) gr).getModels()) {
      mc.addAll(tm.getConfigurations());
    }
  }
}

package dependencies;

/*Generated by MPS */

import jetbrains.mps.internal.collections.runtime.*;
import jetbrains.mps.make.resources.IResource;
import jetbrains.mps.make.resources.IResourceClusterizer;
import jetbrains.mps.project.IModule;
import jetbrains.mps.smodel.resources.IMResource;

import java.util.List;

public class ModulesClusterizer implements IResourceClusterizer {
  public ModulesClusterizer() {
  }

  public Iterable<? extends Iterable<IResource>> clusterize(Iterable<IResource> res) {
    final Iterable<IResource> mres = Sequence.fromIterable(res).where(new IWhereFilter<IResource>() {
      public boolean accept(IResource r) {
        return r instanceof IMResource;
      }
    }).toListSequence();
    Iterable<IModule> mods = Sequence.fromIterable(mres).<IModule>select(new ISelector<IResource, IModule>() {
      public IModule select(IResource r) {
        return ((IMResource) r).module();
      }
    });
    List<IResource> rest = Sequence.fromIterable(res).subtract(Sequence.fromIterable(mres)).toListSequence();
    ModulesCluster clst = new ModulesCluster(mods);
    clst.collectRequired(mods);
    return Sequence.fromIterable(clst.buildOrder()).<List<IResource>>select(new ISelector<Iterable<IModule>, IListSequence<IResource>>() {
      public IListSequence<IResource> select(final Iterable<IModule> cl) {
        return Sequence.fromIterable(mres).where(new IWhereFilter<IResource>() {
          public boolean accept(IResource r) {
            return Sequence.fromIterable(cl).contains(((IMResource) r).module());
          }
        }).toListSequence();
      }
    }).concat(Sequence.fromIterable((ListSequence.fromList(rest).isNotEmpty() ?
      Sequence.<List<IResource>>singleton(rest) :
      null
    ))).toListSequence();
  }
}

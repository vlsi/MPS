package jetbrains.mps.baseLanguage.unitTest.plugin;

/*Generated by MPS */

import com.intellij.execution.process.DefaultJavaProcessHandler;
import java.nio.charset.Charset;
import com.intellij.execution.process.ProcessAdapter;
import com.intellij.execution.process.ProcessTerminatedListener;
import com.intellij.execution.process.ProcessEvent;
import com.intellij.openapi.util.Key;
import com.intellij.execution.process.ProcessOutputTypes;
import org.apache.commons.lang.StringUtils;
import jetbrains.mps.baseLanguage.unitTest.runtime.TestEvent;
import javax.swing.SwingUtilities;

public class UnitTestProcessHandler extends DefaultJavaProcessHandler {
  private UnitTestViewComponent myComponent;

  public UnitTestProcessHandler(final UnitTestViewComponent component, Process process, String params) {
    super(process, params, Charset.defaultCharset());
    this.myComponent = component;

    this.addProcessListener(new ProcessAdapter() {
      private StringBuffer buffer = new StringBuffer();

      private String getLine(String text, StringBuffer buffer) {
        buffer.append(text);
        if (buffer.toString().contains("\n")) {
          int pos = buffer.toString().lastIndexOf("\n");
          String lineToAppend = buffer.toString().substring(0, pos);
          buffer.replace(0, pos, "");
          return lineToAppend;
        } else {
          return null;
        }
      }

      private boolean isTerminatedEvent() {
        for (StackTraceElement element : Thread.currentThread().getStackTrace()) {
          if (element.getClassName().equals(ProcessTerminatedListener.class.getName())) {
            return true;
          }
        }
        return false;
      }

      public void onTextAvailable(ProcessEvent event, final Key k) {
        if (this.isTerminatedEvent()) {
          UnitTestProcessHandler.this.myComponent.getTestListener().onProcessTerminated(event.getText());
        }
        final String className = UnitTestProcessHandler.this.myComponent.getCurrentClassName();
        final String methodName = UnitTestProcessHandler.this.myComponent.getCurrentMethodName();
        boolean error = ProcessOutputTypes.STDERR.equals(k);
        boolean system = ProcessOutputTypes.SYSTEM.equals(k);
        final String text = (error || system ?
          event.getText() :
          this.getLine(event.getText(), this.buffer)
        );
        if (text == null) {
          return;
        }
        String textTrimmed = StringUtils.trim(text);
        final String token = TestEvent.isTestEvent(textTrimmed);
        final TestEvent testEvent = TestEvent.parse(textTrimmed);
        if (testEvent != null) {
          UnitTestProcessHandler.this.myComponent.getTestListener().onTestEvent(testEvent);
        }
        SwingUtilities.invokeLater(new Runnable() {
          public void run() {
            if (token == null) {
              component.appendWithParameters(className, methodName, text, k);
            } else {
              if (testEvent == null) {
                component.appendWithParameters(className, methodName, text, k);
                return;
              }
            }
          }
        });
      }
    });
    ProcessTerminatedListener.attach(this);
  }
}

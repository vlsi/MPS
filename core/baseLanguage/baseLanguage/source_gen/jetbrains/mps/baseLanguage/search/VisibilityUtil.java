package jetbrains.mps.baseLanguage.search;

/*Generated by MPS */

import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.typesystem.inference.TypeChecker;
import jetbrains.mps.baseLanguage.classifiers.behavior.IClassifier_Behavior;
import jetbrains.mps.lang.typesystem.runtime.HUtil;
import jetbrains.mps.baseLanguage.BaseLanguageUtil;
import jetbrains.mps.baseLanguage.structure.Classifier;

public final class VisibilityUtil {
  private VisibilityUtil() {
  }

  public static boolean isVisible(SNode contextNode, SNode member) {
    if (contextNode == null) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(member, "jetbrains.mps.baseLanguage.structure.EnumConstantDeclaration")) {
      return true;
    }
    SNode visibility = SLinkOperations.getTarget(member, "visibility", true);
    if (SNodeOperations.isInstanceOf(visibility, "jetbrains.mps.baseLanguage.structure.PublicVisibility")) {
      return true;
    }
    if (visibility == null) {
      return SNodeOperations.getModel(member).getSModelFqName().getNamespace().equals(SNodeOperations.getModel(contextNode).getSModelFqName().getNamespace());
    }
    if (SNodeOperations.isInstanceOf(visibility, "jetbrains.mps.baseLanguage.structure.ProtectedVisibility") && SNodeOperations.getModel(member).getSModelFqName().getNamespace().equals(SNodeOperations.getModel(contextNode).getSModelFqName().getNamespace())) {
      return true;
    }
    if (!(SNodeOperations.isInstanceOf(member, "jetbrains.mps.baseLanguage.structure.ClassifierMember"))) {
      return true;
    }
    SNode memberClassifier = SNodeOperations.getAncestor(member, "jetbrains.mps.baseLanguage.structure.Classifier", true, false);
    if (memberClassifier == null) {
      return true;
    }
    SNode contextClassifier = VisibilityUtil.getAncestorClassifier(contextNode);
    while (contextClassifier != null) {
      if (memberClassifier == contextClassifier) {
        return true;
      }
      if (SNodeOperations.isInstanceOf(visibility, "jetbrains.mps.baseLanguage.structure.ProtectedVisibility")) {
        SNode tmpContextClassifier;

        if (SNodeOperations.isInstanceOf(contextClassifier, "jetbrains.mps.baseLanguage.structure.Classifier")) {
          tmpContextClassifier = SNodeOperations.cast(contextClassifier, "jetbrains.mps.baseLanguage.structure.Classifier");
        } else if (SNodeOperations.isInstanceOf(contextClassifier, "jetbrains.mps.baseLanguage.classifiers.structure.IClassifier")) {
          SNode classifierType = TypeChecker.getInstance().getRuntimeSupport().coerce_(IClassifier_Behavior.call_createType_1213877527970(SNodeOperations.cast(contextClassifier, "jetbrains.mps.baseLanguage.classifiers.structure.IClassifier")), HUtil.createMatchingPatternByConceptFQName("jetbrains.mps.baseLanguage.structure.ClassifierType"), true);
          tmpContextClassifier = SLinkOperations.getTarget(classifierType, "classifier", false);
        } else {
          throw new IllegalStateException();
        }

        if (BaseLanguageUtil.isAssignable(((Classifier) SNodeOperations.getAdapter(tmpContextClassifier)), ((Classifier) SNodeOperations.getAdapter(memberClassifier)))) {
          return true;
        }
      }
      SNode parent = getAncestorClassifier(contextClassifier);
      if (parent == null) {
        break;
      }
      contextClassifier = parent;
    }
    while (memberClassifier != null) {
      SNode parent = SNodeOperations.getAncestor(memberClassifier, "jetbrains.mps.baseLanguage.structure.Classifier", false, false);
      if (parent == null) {
        if (memberClassifier == contextClassifier) {
          return true;
        }
      }
      memberClassifier = parent;
    }
    return false;
  }

  private static SNode getAncestorClassifier(SNode contextNode) {
    return SNodeOperations.getAncestorWhereConceptInList(contextNode, new String[]{"jetbrains.mps.baseLanguage.structure.Classifier","jetbrains.mps.baseLanguage.classifiers.structure.IClassifier"}, true, false);
  }
}

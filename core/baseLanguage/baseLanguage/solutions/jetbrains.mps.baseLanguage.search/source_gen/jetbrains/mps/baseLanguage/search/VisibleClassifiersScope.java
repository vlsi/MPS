package jetbrains.mps.baseLanguage.search;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.smodel.IScope;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import jetbrains.mps.baseLanguage.structure.Classifier;
import java.util.ArrayList;
import jetbrains.mps.smodel.BaseAdapter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;

public class VisibleClassifiersScope extends ReachableClassifiersScope {
  protected static Log log = LogFactory.getLog(VisibleClassifiersScope.class);

  private SNode myContextNode = null;

  @Deprecated
  public VisibleClassifiersScope(SModel model, int constraint, IScope scope) {
    super(model, constraint, scope);
  }

  public VisibleClassifiersScope(@NotNull SNode contextNode, int constraint, IScope scope) {
    super(SNodeOperations.getModel(contextNode), constraint, scope);
    myContextNode = contextNode;
  }

  @NotNull
  public List<Classifier> getClassifiers() {
    List<Classifier> list = super.getClassifiers();
    List<Classifier> result = new ArrayList<Classifier>();
    for (Classifier classifier : list) {
      if (VisibilityUtil.isVisible(myContextNode, SNodeOperations.cast(BaseAdapter.fromAdapter(classifier), "jetbrains.mps.baseLanguage.structure.IVisible"))) {
        result.add(classifier);
      }
    }
    return result;
  }

  public boolean isInScope(SNode node) {
    // speed up IVisible nodes with context 
    if (!(SNodeOperations.isInstanceOf(node, "jetbrains.mps.baseLanguage.structure.IVisible"))) {
      if (log.isErrorEnabled()) {
        log.error("isInScope(" + node + ") - not instance of IVisible");
      }
      return super.isInScope(node);
    }
    // check only NON_FINAL constraint, other constraints should be enforced by the reference type 
    if ((getConstraint() & NON_FINAL) != 0 && SNodeOperations.isInstanceOf(node, "jetbrains.mps.baseLanguage.structure.ClassConcept") && SPropertyOperations.getBoolean(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.ClassConcept"), "isFinal")) {
      return false;
    }
    return VisibilityUtil.isVisible(myContextNode, SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.IVisible"));
  }
}

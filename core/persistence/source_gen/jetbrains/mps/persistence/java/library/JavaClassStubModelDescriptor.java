package jetbrains.mps.persistence.java.library;

/*Generated by MPS */

import jetbrains.mps.extapi.model.ReloadableSModelBase;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import jetbrains.mps.smodel.SModel;
import org.jetbrains.mps.openapi.persistence.ModelRoot;
import org.jetbrains.mps.openapi.model.SModelReference;
import jetbrains.mps.extapi.persistence.FolderSetDataSource;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.loading.ModelLoadingState;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.nodeidmap.ForeignNodeIdMap;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.baseLanguage.javastub.ASMModelLoader;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.project.ModuleId;
import jetbrains.mps.smodel.SModelRepository;

public class JavaClassStubModelDescriptor extends ReloadableSModelBase {
  private static final Logger LOG = LogManager.getLogger(JavaClassStubModelDescriptor.class);

  private SModel myModel;
  private ModelRoot myModelRoot;
  public JavaClassStubModelDescriptor(SModelReference modelReference, FolderSetDataSource source, ModelRoot root) {
    super(modelReference, source);
    myModelRoot = root;
  }
  @Override
  protected SModel getCurrentModelInternal() {
    return myModel;
  }
  @NotNull
  @Override
  public FolderSetDataSource getSource() {
    return (FolderSetDataSource) super.getSource();
  }
  @Override
  public SModel getSModelInternal() {
    if (myModel == null) {
      synchronized (this) {
        if (myModel != null) {
          return myModel;
        }
        myModel = createModel();
        myModel.setModelDescriptor(this);
      }
      fireModelStateChanged(ModelLoadingState.FULLY_LOADED);
    }
    return myModel;
  }
  @Override
  public boolean isLoaded() {
    return myModel != null;
  }
  @Override
  public void unload() {
    ModelAccess.assertLegalWrite();

    SModel oldModel = myModel;
    if (oldModel != null) {
      oldModel.setModelDescriptor(null);
      myModel = null;
      fireModelStateChanged(ModelLoadingState.NOT_LOADED);
    }
  }
  private SModel createModel() {
    SModel model = new SModel(getReference(), new ForeignNodeIdMap());
    for (Language l : getLanguagesToImport()) {
      model.addLanguage(l.getModuleReference());
    }
    new ASMModelLoader(myModelRoot.getModule(), getSource().getPaths(), model, false).updateModel();
    return model;
  }
  protected Set<Language> getLanguagesToImport() {
    Set<String> moduleIds = SetSequence.fromSet(new HashSet<String>());
    SetSequence.fromSet(moduleIds).addElement(PersistenceFacade.getInstance().createModuleReference("f3061a53-9226-4cc5-a443-f952ceaf5816(jetbrains.mps.baseLanguage)").getModuleId().toString());
    Iterable<Language> languages = SetSequence.fromSet(moduleIds).select(new ISelector<String, Language>() {
      public Language select(String it) {
        return ((Language) MPSModuleRepository.getInstance().getModule(ModuleId.fromString(it)));
      }
    });
    return SetSequence.fromSetWithValues(new HashSet<Language>(), languages);
  }
  @Override
  public void reloadFromDiskSafe() {
    ModelAccess.assertLegalWrite();
    if (getSource().getPaths().isEmpty()) {
      SModelRepository.getInstance().deleteModel(this);
      return;
    }
    reload();
    updateTimestamp();
    LOG.assertLog(!(needsReloading()), "Assertion failed.");
  }
  private void reload() {
    if (myModel == null) {
      return;
    }
    final SModel oldModel = myModel;
    myModel = createModel();
    replaceModelAndFireEvent(oldModel, myModel);
  }
}

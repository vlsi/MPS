package jetbrains.mps.workbench.dialogs.project.components.parts.boundpanels;

/*Generated by MPS */

import javax.swing.JList;
import com.intellij.ui.components.JBList;
import jetbrains.mps.workbench.dialogs.project.IBindedDialog;
import java.util.List;
import javax.swing.JComponent;
import org.jdesktop.swingbinding.SwingBindings;
import org.jdesktop.beansbinding.AutoBinding;
import jetbrains.mps.workbench.dialogs.project.components.parts.actions.BaseValidatedAction;
import jetbrains.mps.util.Computable;
import jetbrains.mps.workbench.dialogs.project.components.parts.actions.ListAddAction;
import com.intellij.openapi.actionSystem.AnActionEvent;
import jetbrains.mps.workbench.dialogs.project.components.parts.actions.ListRemoveAction;
import com.intellij.openapi.ui.Messages;

public class BoundListPanel<T> extends ValidateableBoundPanel<T> {
  private JList myUIList = new JBList();

  public BoundListPanel(IBindedDialog owner, String caption, List<T> ts) {
    super(owner, caption, ts);
  }

  @Override
  protected JComponent initUIComponentAndBinding() {
    if (myCellRenderer != null) {
      myUIList.setCellRenderer(myCellRenderer);
    }
    myOwner.addBinding(SwingBindings.createJListBinding(AutoBinding.UpdateStrategy.READ_WRITE, myList, myUIList));
    return myUIList;
  }

  @Override
  protected BaseValidatedAction createAddAction(Computable<List<T>> chooser) {
    return new BoundListPanel.MyListAddAction(chooser);
  }

  @Override
  protected BaseValidatedAction createRemoveAction() {
    return new BoundListPanel.MyListRemoveAction();
  }

  @Override
  protected int[] getSelectedIndices() {
    return myUIList.getSelectedIndices();
  }

  public JList getList() {
    return myUIList;
  }

  private class MyListAddAction extends ListAddAction {
    private Computable<List<T>> myChooser;

    public MyListAddAction(Computable<List<T>> chooser) {
      super(myUIList);
      myChooser = chooser;
    }

    @Override
    protected int doAdd(AnActionEvent e) {
      List<T> chosen = myChooser.compute();
      if (chosen == null) {
        return -1;
      }
      BoundListPanel.this.myList.addAll(chosen);
      super.doAdd(e);
      T first = ((chosen.isEmpty() ?
        null :
        chosen.get(0)
      ));
      return ((first == null) ?
        -1 :
        BoundListPanel.this.myList.indexOf(first)
      );
    }
  }

  private class MyListRemoveAction extends ListRemoveAction {
    public MyListRemoveAction() {
      super(myUIList);
    }

    @Override
    protected void doRemove(AnActionEvent e) {
      String errorMessage = BoundListPanel.this.removeSelectedWithCheck();
      if ((errorMessage == null || errorMessage.length() == 0)) {
        return;
      }
      if (!(myAllowRemoveAnyway)) {
        Messages.showWarningDialog("<html>Can't remove " + errorMessage + ".</html>", "Error Removing Element");
      } else if (Messages.showYesNoDialog("<html>Can't remove " + errorMessage + ".<br><br>Remove anyway?<br>This can result in broken models.</html>", "Error Removing Element", Messages.getWarningIcon()) == 0) {
        BoundListPanel.this.removeSelected();
      }
    }
  }
}

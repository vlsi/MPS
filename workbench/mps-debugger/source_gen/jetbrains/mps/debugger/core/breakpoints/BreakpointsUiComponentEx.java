package jetbrains.mps.debugger.core.breakpoints;

/*Generated by MPS */

import com.intellij.openapi.fileEditor.FileEditorManager;
import com.intellij.openapi.project.Project;
import jetbrains.mps.nodeEditor.LeftMarginMouseListener;
import com.intellij.util.messages.MessageBusConnection;
import jetbrains.mps.nodeEditor.highlighter.EditorComponentCreateListener;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.ide.editor.util.EditorComponentUtil;
import java.util.Set;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import jetbrains.mps.traceInfo.DebugInfo;
import jetbrains.mps.generator.traceInfo.TraceInfoCache;
import jetbrains.mps.generator.traceInfo.TraceDown;
import jetbrains.mps.util.Condition;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.List;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.awt.event.MouseEvent;
import jetbrains.mps.smodel.ModelAccess;

/**
 * 
 * 
 * @param B breakpoint type
 * @param L location breakpoint type
 */
public abstract class BreakpointsUiComponentEx<B, L extends B> {
  protected final FileEditorManager myFileEditorManager;
  protected final Project myProject;
  private final LeftMarginMouseListener myMouseListener = new BreakpointsUiComponentEx.MyLeftMarginMouseListener();
  private final BreakpointsUiComponentEx.MyEditorComponentCreateListener myEditorComponentCreationHandler = new BreakpointsUiComponentEx.MyEditorComponentCreateListener();
  private MessageBusConnection myMessageBusConnection;

  public BreakpointsUiComponentEx(Project project, FileEditorManager manager) {
    myProject = project;
    myFileEditorManager = manager;
  }

  public void init() {
    myMessageBusConnection = myProject.getMessageBus().connect();
    myMessageBusConnection.subscribe(EditorComponentCreateListener.EDITOR_COMPONENT_CREATION, myEditorComponentCreationHandler);
    for (EditorComponent editor : EditorComponentUtil.getAllEditorComponents(myFileEditorManager, true)) {
      editorComponentCreated(editor);
    }
  }

  public void dispose() {
    myMessageBusConnection.disconnect();
  }

  protected abstract Set<L> getBreakpointsForComponent(@NotNull EditorComponent component);

  protected abstract BreakpointPainterEx<L> createPainter(L breakpoint);

  protected abstract BreakpointIconRenderrerEx<L> createRenderrer(L breakpoint, EditorComponent component);

  protected abstract void toggleBreakpoint(SNode node);

  protected abstract EditorCell findDebuggableOrTraceableCell(EditorCell cell);

  public void toggleBreakpoint(EditorCell cell) {
    EditorCell debuggableCell = findDebuggableOrTraceableCell(cell);
    if (debuggableCell != null) {
      toggleBreakpoint(debuggableCell.getSNode());
    }
  }

  public boolean isDebuggable(EditorCell cell) {
    return findDebuggableOrTraceableCell(cell) != null;
  }

  protected EditorCell findTraceableCell(EditorCell foundCell) {
    DebugInfo debugInfo = TraceInfoCache.getInstance().get(foundCell.getEditor().getEditedNode().getModel().getModelDescriptor());
    if (debugInfo == null) {
      return null;
    }

    EditorCell cell = foundCell;
    while (cell != null) {
      SNode node = cell.getSNode();
      if (node != null) {
        if (TraceDown.isTraceable(node, debugInfo)) {
          break;
        }
      }
      cell = (EditorCell) cell.getParent();
    }
    return cell;
  }

  private SNode findDebuggableNode(final EditorComponent editorComponent, int x, final int y) {
    EditorCell foundCell = editorComponent.getRootCell().findCellWeak(x, y, new Condition<EditorCell>() {
      @Override
      public boolean met(EditorCell object) {
        EditorCell debuggableOrTraceableCell = findDebuggableOrTraceableCell(object);
        if (debuggableOrTraceableCell == null) {
          return false;
        }
        //  todo do we need to know about ui? 
        EditorCell iconAnchorCell = BreakpointIconRenderrerEx.getBreakpointIconAnchorCell(editorComponent.findNodeCell(debuggableOrTraceableCell.getSNode()));
        //  ignoring mouse clicks to any other rows except one containing "BreakpointIconAnchorCell" 
        //  (this cell will be marked with breakpoint icon in LeftEditorHighlighter) 
        return (y >= iconAnchorCell.getY() && iconAnchorCell.getBaseline() >= y);
      }
    });
    if (foundCell == null) {
      return null;
    }
    EditorCell cell = findDebuggableOrTraceableCell(foundCell);
    if (cell == null) {
      return null;
    }
    return cell.getSNode();
  }

  protected void editorComponentCreated(@Nullable EditorComponent editorComponent) {
    if (editorComponent == null) {
      return;
    }
    if (!(editorComponent.getLeftMarginPressListeners().contains(myMouseListener))) {
      editorComponent.addLeftMarginPressListener(myMouseListener);
    }
    Set<L> breakpointsForRoot = getBreakpointsForComponent(editorComponent);
    for (L breakpoint : SetSequence.fromSet(breakpointsForRoot)) {
      editorComponent.addAdditionalPainter(createPainter(breakpoint));
      editorComponent.getLeftEditorHighlighter().addIconRenderer(createRenderrer(breakpoint, editorComponent));
    }
    editorComponent.repaint();
  }

  protected void editorComponentDisposed(@Nullable EditorComponent editorComponent) {
    if (editorComponent == null) {
      return;
    }
    editorComponent.removeLeftMarginPressListener(myMouseListener);
    Set<L> breakpointsForRoot = getBreakpointsForComponent(editorComponent);
    for (L breakpoint : SetSequence.fromSet(breakpointsForRoot)) {
      editorComponent.removeAdditionalPainterByItem(breakpoint);
    }
    editorComponent.getLeftEditorHighlighter().removeAllIconRenderers(BreakpointIconRenderrerEx.TYPE);
  }

  protected void addLocationBreakpoint(L breakpoint, SNode node) {
    List<EditorComponent> editorComponents = EditorComponentUtil.findComponentForNode(node, myFileEditorManager);
    for (EditorComponent editorComponent : editorComponents) {
      editorComponent.addAdditionalPainter(createPainter(breakpoint));
      editorComponent.getLeftEditorHighlighter().addIconRenderer(createRenderrer(breakpoint, editorComponent));
      editorComponent.repaint();
    }
  }

  protected void removeLocationBreakpoint(L breakpoint, SNode node) {
    List<EditorComponent> editorComponents = EditorComponentUtil.findComponentForNode(node, myFileEditorManager);
    for (EditorComponent editorComponent : editorComponents) {
      editorComponent.removeAdditionalPainterByItem(breakpoint);
      editorComponent.getLeftEditorHighlighter().removeIconRenderer(node, BreakpointIconRenderrerEx.TYPE);
      editorComponent.repaint();
    }
  }

  public void repaintBreakpoints() {
    ApplicationManager.getApplication().invokeLater(new Runnable() {
      public void run() {
        List<EditorComponent> allEditorComponents = EditorComponentUtil.getAllEditorComponents(myFileEditorManager, true);
        for (EditorComponent component : ListSequence.fromList(allEditorComponents)) {
          component.repaint();
        }
      }
    });
  }

  private class MyLeftMarginMouseListener implements LeftMarginMouseListener {
    private MyLeftMarginMouseListener() {
    }

    @Override
    public void mousePressed(MouseEvent e, EditorComponent editorComponent) {
    }

    @Override
    public void mouseReleased(MouseEvent e, EditorComponent editorComponent) {
    }

    @Override
    public void mouseClicked(final MouseEvent e, final EditorComponent editorComponent) {
      if (e.getButton() == MouseEvent.BUTTON1) {
        ModelAccess.instance().runReadAction(new Runnable() {
          @Override
          public void run() {
            SNode node = findDebuggableNode(editorComponent, e.getX(), e.getY());
            if (node != null) {
              toggleBreakpoint(node);
            }
          }
        });
      }
    }
  }

  private class MyEditorComponentCreateListener implements EditorComponentCreateListener {
    private MyEditorComponentCreateListener() {
    }

    @Override
    public void editorComponentCreated(@NotNull EditorComponent editorComponent) {
      BreakpointsUiComponentEx.this.editorComponentCreated(editorComponent);
    }

    @Override
    public void editorComponentDisposed(@NotNull EditorComponent editorComponent) {
      BreakpointsUiComponentEx.this.editorComponentDisposed(editorComponent);
    }
  }
}

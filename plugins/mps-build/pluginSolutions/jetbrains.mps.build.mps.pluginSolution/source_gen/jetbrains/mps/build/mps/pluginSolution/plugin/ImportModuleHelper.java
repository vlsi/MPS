package jetbrains.mps.build.mps.pluginSolution.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import jetbrains.mps.build.mps.util.PathConverter;
import jetbrains.mps.project.structure.modules.LanguageDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.project.structure.modules.SolutionDescriptor;
import jetbrains.mps.project.structure.modules.DevkitDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.build.mps.util.VisibleModules;
import jetbrains.mps.build.mps.util.ModuleLoader;
import jetbrains.mps.logging.Logger;

public class ImportModuleHelper {
  private SNode project;
  private IFile moduleFile;
  private ModuleDescriptor moduleDescriptor;
  private PathConverter converter;
  private SNode created;

  public ImportModuleHelper(SNode project, PathConverter converter, IFile moduleFile, ModuleDescriptor moduleDescriptor) {
    this.project = project;
    this.moduleFile = moduleFile;
    this.moduleDescriptor = moduleDescriptor;
    this.converter = converter;
  }

  public void create() {
    try {
      if (moduleDescriptor instanceof LanguageDescriptor) {
        jetbrains.mps.smodel.SNode lang = SConceptOperations.createNewNode("jetbrains.mps.build.mps.structure.BuildMps_Language", null);
        initModule(lang);
        created = lang;
      } else if (moduleDescriptor instanceof SolutionDescriptor) {
        jetbrains.mps.smodel.SNode solution = SConceptOperations.createNewNode("jetbrains.mps.build.mps.structure.BuildMps_Solution", null);
        initModule(solution);
        created = solution;
      } else if (moduleDescriptor instanceof DevkitDescriptor) {
        jetbrains.mps.smodel.SNode devkit = SConceptOperations.createNewNode("jetbrains.mps.build.mps.structure.BuildMps_DevKit", null);
        initModule(devkit);
        created = devkit;
      }
      ListSequence.fromList(SLinkOperations.getTargets(project, "parts", true)).addElement(created);
    } catch (PathConverter.PathConvertException ex) {
      // ignore 
      LOG.error(ex.getMessage());
    }
  }

  private void initModule(SNode module) throws PathConverter.PathConvertException {
    SPropertyOperations.set(module, "compact", "" + (true));
    SPropertyOperations.set(module, "name", moduleDescriptor.getModuleReference().getModuleFqName());
    SPropertyOperations.set(module, "uuid", moduleDescriptor.getModuleReference().getModuleId().toString());
    SLinkOperations.setTarget(module, "path", ListSequence.fromList(converter.convertPath(moduleFile.getPath(), SNodeOperations.getModel(project))).first(), true);
  }

  public void update(VisibleModules visible) {
    if ((created == null)) {
      return;
    }

    try {
      new ModuleLoader(created, visible, converter, null).importRequired();
    } catch (ModuleLoader.ModuleLoaderException ex) {
      LOG.error(ex.getMessage());
    }
  }

  private static Logger LOG = Logger.getLogger(ImportModuleHelper.class);
}

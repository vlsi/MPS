package jetbrains.mps.baseLanguage.unitTest.execution.settings;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.unitTest.execution.client.ITestNodeWrapper;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.backports.LinkedList;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import org.jetbrains.mps.openapi.language.SConceptRepository;
import jetbrains.mps.util.NameUtil;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;

public class LightExecutionFilter implements Filter<ITestNodeWrapper> {
  @Override
  public boolean accept(Iterable<ITestNodeWrapper> ts) {
    return true;
    // TODO REMOVE!!! 
    // <node> 
  }

  @Override
  public Iterable<ITestNodeWrapper> filter(final Iterable<ITestNodeWrapper> ts) {
    final List<ITestNodeWrapper> seq = ListSequence.fromList(new LinkedList<ITestNodeWrapper>());
    ModelAccess.instance().runReadAction(new Runnable() {
      @Override
      public void run() {
        ListSequence.fromList(seq).addSequence(Sequence.fromIterable(ts).where(new IWhereFilter<ITestNodeWrapper>() {
          public boolean accept(ITestNodeWrapper it) {
            SNode testNode = it.getNode();
            SNode rootNode = SNodeOperations.getContainingRoot(testNode);
            if (!(SNodeOperations.isInstanceOf(testNode, "jetbrains.mps.baseLanguage.unitTest.structure.ITestable"))) {
              return false;
            }
            if (!(SNodeOperations.isInstanceOf(rootNode, "jetbrains.mps.lang.test.structure.EditorTestCase")) && !(SNodeOperations.isInstanceOf(rootNode, "jetbrains.mps.lang.test.structure.NodesTestCase"))) {
              return false;
            }
            if (BehaviorReflection.invokeNonVirtualStatic(Boolean.TYPE, SConceptRepository.getInstance().getConcept(NameUtil.nodeFQName(SConceptOperations.findConceptDeclaration("jetbrains.mps.lang.test.structure.TestInfo"))), "call_reOpenProject_1031873601093419509", new Object[]{SNodeOperations.getModel(rootNode)})) {
              return false;
            }
            return BehaviorReflection.invokeNonVirtual(Boolean.TYPE, SNodeOperations.cast(testNode, "jetbrains.mps.baseLanguage.unitTest.structure.ITestable"), "jetbrains.mps.baseLanguage.unitTest.structure.ITestable", "call_canRunInProcess_6436735966448788391", new Object[]{});
          }
        }));
      }
    });
    return seq;
  }
}

package jetbrains.mps.execution.configurations.implementation.plugin.plugin;

/*Generated by MPS */

import com.intellij.openapi.project.Project;
import jetbrains.mps.baseLanguage.unitTest.execution.settings.JUnitSettings_Configuration;
import jetbrains.mps.debug.api.IDebuggerSettings;
import jetbrains.mps.baseLanguage.execution.api.JavaRunParameters_Configuration;
import java.util.List;
import jetbrains.mps.baseLanguage.unitTest.execution.client.ITestNodeWrapper;
import com.intellij.execution.process.ProcessHandler;
import com.intellij.execution.ExecutionException;
import jetbrains.mps.baseLanguage.unitTest.execution.client.RunCachesManager;
import jetbrains.mps.baseLanguage.unitTest.execution.client.JUnit_Command;
import com.intellij.execution.process.ProcessAdapter;
import com.intellij.execution.process.ProcessEvent;
import jetbrains.mps.baseLanguage.execution.api.JavaRunParameters;
import jetbrains.mps.util.test.CachesUtil;
import com.intellij.util.ui.UIUtil;
import com.intellij.openapi.wm.ToolWindowManager;
import com.intellij.openapi.ui.MessageType;

public class JUnitExecutor implements Executor {
  private final Project myProject;
  private final com.intellij.execution.Executor myExecutor;
  private final JUnitSettings_Configuration myJUnitSettings;
  private final IDebuggerSettings myDebuggerSettings;
  private final JavaRunParameters_Configuration myJavaRunParameters;
  private final List<ITestNodeWrapper> myTestNodes;

  public JUnitExecutor(Project project, com.intellij.execution.Executor executor, JUnitSettings_Configuration jUnitSettings, IDebuggerSettings debuggerSettings, JavaRunParameters_Configuration javaRunParameters, List<ITestNodeWrapper> testNodes) {
    myProject = project;
    myExecutor = executor;
    myJUnitSettings = jUnitSettings;
    myDebuggerSettings = debuggerSettings;
    myJavaRunParameters = javaRunParameters;
    myTestNodes = testNodes;
  }

  @Override
  public ProcessHandler execute() throws ExecutionException {
    final boolean reuseCaches = myJUnitSettings.getReuseCaches() && RunCachesManager.acquireLock();
    ProcessHandler commandProcess = new JUnit_Command().setDebuggerSettings_String(myDebuggerSettings.getCommandLine(true)).createProcess(myTestNodes, this.prepareJavaParamsForTests(reuseCaches, myJUnitSettings.getCachesDir()));
    commandProcess.addProcessListener(new ProcessAdapter() {
      @Override
      public void processTerminated(ProcessEvent p0) {
        if (reuseCaches) {
          RunCachesManager.releaseLock();
        }
      }
    });
    return commandProcess;
  }

  public JavaRunParameters prepareJavaParamsForTests(boolean reuseCaches, String cachesDir) {
    JavaRunParameters_Configuration javaRunParams = myJavaRunParameters;
    JavaRunParameters parameters = javaRunParams.getJavaRunParameters().clone();
    String vmFromJava = javaRunParams.getJavaRunParameters().getVmOptions();
    if (vmFromJava == null) {
      vmFromJava = "";
    }
    if (reuseCaches) {
      String runIdString = "-D" + CachesUtil.REUSE_CACHES_DIR + "=\"" + cachesDir + "\"";
      parameters.setVmOptions(vmFromJava + " " + runIdString);
    } else {
      if (myJUnitSettings.getReuseCaches()) {
        // could not acquire the lock 
        UIUtil.invokeLaterIfNeeded(new Runnable() {
          public void run() {
            ToolWindowManager.getInstance(myProject).notifyByBalloon(myExecutor.getId(), MessageType.WARNING, "Cannot reuse caches, because the directory is locked by another run.\nSaving caches in the " + " temp directory...");
          }
        });
      }
    }
    return parameters;
  }

}

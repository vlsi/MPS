package jetbrains.mps.ide.make.actions;

/*Generated by MPS */

import com.intellij.openapi.wm.StatusBarWidget;
import com.intellij.openapi.wm.CustomStatusBarWidget;
import com.intellij.ide.ui.UISettingsListener;
import java.beans.PropertyChangeListener;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.wm.StatusBar;
import javax.swing.Icon;
import com.intellij.ide.ui.UISettings;
import java.awt.KeyboardFocusManager;
import org.jetbrains.annotations.Nullable;
import com.intellij.util.Consumer;
import java.awt.event.MouseEvent;
import jetbrains.mps.ide.generator.GenerationSettings;
import java.awt.Dimension;
import java.awt.Point;
import com.intellij.ui.awt.RelativePoint;
import javax.swing.JComponent;
import java.beans.PropertyChangeEvent;

/*package*/ class TransientModelsWidget implements StatusBarWidget, CustomStatusBarWidget, StatusBarWidget.TextPresentation, StatusBarWidget.WidgetPresentation, UISettingsListener, PropertyChangeListener {
  public static final String WIDGET_ID = "TransientModelsWidget";
  @NotNull
  private final StatusBar myStatusBar;
  private final Icon myIcon = IconContainer.ICON_a2;
  private final Icon myIconDisable = IconContainer.ICON_a3;
  private TransientModelsPanel myComponent;
  public TransientModelsWidget(StatusBar bar) {
    myStatusBar = bar;
    myComponent = new TransientModelsPanel(this);

    // Use approach from com.intellij.openapi.wm.impl.status.ToolWindowsWidget 
    UISettings.getInstance().addUISettingsListener(this, this);
    KeyboardFocusManager.getCurrentKeyboardFocusManager().addPropertyChangeListener("focusOwner", this);
  }
  @Override
  public void install(@NotNull StatusBar bar) {
  }
  @Nullable
  @Override
  public String getTooltipText() {
    if (isSaveTransientModels()) {
      return "Stop saving transient models";
    }
    return "Save transient models";
  }
  @Nullable
  @Override
  public Consumer<MouseEvent> getClickConsumer() {
    return new Consumer<MouseEvent>() {
      @Override
      public void consume(MouseEvent e) {
        if (!(e.isPopupTrigger()) && MouseEvent.BUTTON1 == e.getButton()) {
          boolean saveTransientModels = GenerationSettings.getInstance().isSaveTransientModels();
          GenerationSettings.getInstance().setSaveTransientModels(!(saveTransientModels));
          TransientModelsNotification.updateWidgets();
        } else if (e.isPopupTrigger() || MouseEvent.BUTTON2 == e.getButton()) {
          WidgetSettingsPanel panel = new WidgetSettingsPanel();
          Dimension dimension = panel.getPreferredSize();
          Point point = new Point(0, 0);
          point = new Point(point.x - dimension.width, point.y - dimension.height);
          panel.showComponent(new RelativePoint(e.getComponent(), point));
        }
      }
    };
  }
  public void update() {
    myComponent.update();
    myStatusBar.updateWidget(ID());
  }
  @Nullable
  @Override
  public StatusBarWidget.WidgetPresentation getPresentation(@NotNull StatusBarWidget.PlatformType type) {
    return this;
  }
  @Override
  public void dispose() {
  }
  @NotNull
  /*package*/ Icon getIcon() {
    if (isSaveTransientModels()) {
      return myIcon;
    }
    // TODO: Use only one Icon. This hack helps to avoid tests fails 
    return myIconDisable;
  }
  @NotNull
  @Override
  public String ID() {
    return WIDGET_ID;
  }
  public boolean isSaveTransientModels() {
    return GenerationSettings.getInstance().isSaveTransientModels();
  }
  @Override
  public JComponent getComponent() {
    return this.myComponent;
  }
  @NotNull
  public String getText() {
    if (isSaveTransientModels()) {
      return ":ON ";
    }
    return ":OFF";
  }
  @NotNull
  public String getMaxPossibleText() {
    return ":OFF";
  }
  public float getAlignment() {
    return JComponent.RIGHT_ALIGNMENT;
  }
  public void uiSettingsChanged(UISettings settings) {
    myComponent.update();
  }
  public void propertyChange(PropertyChangeEvent event) {
    myComponent.update();
  }
}

package jetbrains.mps.build.packaging.behavior;

/*Generated by MPS */

import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.vfs.FileSystem;
import java.util.List;
import jetbrains.mps.project.IModule;
import jetbrains.mps.project.Solution;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import java.io.File;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.project.structure.model.ModelRootDescriptor;
import jetbrains.mps.project.structure.model.ModelRoot;
import jetbrains.mps.smodel.LanguageID;
import jetbrains.mps.internal.collections.runtime.ISequenceClosure;
import java.util.Collection;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.persistence.DefaultModelRoot;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.project.ModuleId;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import jetbrains.mps.util.PathManager;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.project.DevKit;

public class Module_Behavior {
  public static void init(SNode thisNode) {

  }

  public static String call_getTemporalDir_1213877514765(SNode thisNode) {
    return SPropertyOperations.getString(thisNode, "name") + ".tmp";
  }

  public static boolean call_isCompiledInMPS_1213877514774(SNode thisNode) {
    return Module_Behavior.call_getModule_1213877515148(thisNode).isCompileInMPS();
  }

  public static SNode call_getModuleBaseDirectory_6863060912307757632(SNode thisNode) {
    return PathHolder_Behavior.createPathHolder_7235580512916878209(FileSystem.getInstance().getBundleHome(Module_Behavior.call_getModule_1213877515148(thisNode).getDescriptorFile()).getPath(), thisNode);
  }

  public static SNode call_getModuleDescriptorFile_6863060912307764362(SNode thisNode) {
    return PathHolder_Behavior.createPathHolder_7235580512916878209(Module_Behavior.call_getModule_1213877515148(thisNode).getDescriptorFile().getPath(), thisNode);
  }

  public static SNode call_getClassesGen_3315989002810564857(SNode thisNode) {
    return PathHolder_Behavior.createPathHolder_7235580512916878209(Module_Behavior.call_getModule_1213877515148(thisNode).getClassesGen().getPath(), thisNode);
  }

  public static List<SNode> call_getSourcesDirectories_1775602641704992067(SNode thisNode) {
    IModule module = Module_Behavior.call_getModule_1213877515148(thisNode);
    if (module instanceof Solution && !(module.isCompileInMPS())) {
      return new ArrayList<SNode>();
    }
    return Module_Behavior.call_getPathHolders_1213877515000(thisNode, ListSequence.fromList(ListSequence.fromListWithValues(new ArrayList<String>(), module.getSourcePaths())).select(new ISelector<String, String>() {
      public String select(String it) {
        return it.replace(File.separator, Util.SEPARATOR);
      }
    }).distinct().toListSequence(), false);
  }

  public static boolean call_needsOwnStubs_8177148268721488524(SNode thisNode) {
    return Sequence.fromIterable(((Iterable<String>) ((AbstractModule) Module_Behavior.call_getModule_1213877515148(thisNode)).getClassPath())).where(new IWhereFilter<String>() {
      public boolean accept(String it) {
        return !(it.endsWith(".jar"));
      }
    }).isNotEmpty() || Sequence.fromIterable(((Iterable<ModelRootDescriptor>) Module_Behavior.call_getModule_1213877515148(thisNode).getModuleDescriptor().getModelRootDescriptors())).select(new ISelector<ModelRootDescriptor, ModelRoot>() {
      public ModelRoot select(ModelRootDescriptor it) {
        return it.getRoot();
      }
    }).where(new IWhereFilter<ModelRoot>() {
      public boolean accept(ModelRoot it) {
        return it != null && LanguageID.JAVA_MANAGER.equals(it.getManager()) && !(it.getPath().endsWith(".jar"));
      }
    }).isNotEmpty();
  }

  public static List<SNode> call_getClassPathDirectoriesForModuleXml_2378354490355068224(final SNode thisNode) {
    List<SNode> result = new ArrayList<SNode>();
    ListSequence.fromList(result).addSequence(ListSequence.fromList(Module_Behavior.call_getClassPathDirectories_1213877515083(thisNode, true)));

    final AbstractModule module = (AbstractModule) Module_Behavior.call_getModule_1213877515148(thisNode);
    if (!(module.isCompileInMPS())) {
      // todo hack in order to make plugin modules know their classes location 
      final String plugins = "plugins";
      final String classes = "classes";
      String path = Sequence.fromIterable(Sequence.fromClosure(new ISequenceClosure<String>() {
        public Iterable<String> iterable() {
          return Module_Behavior.call_getClassPathExcludingIdea_2000252915626233691(thisNode, module);
        }
      })).findFirst(new IWhereFilter<String>() {
        public boolean accept(String it) {
          return it.contains(plugins) && it.endsWith(classes);
        }
      });
      if (path != null) {
        String classesPath = path.replace("\\", Util.SEPARATOR).replace("/", Util.SEPARATOR);
        if (!(classesPath.startsWith(Module_Behavior.call_getModuleDescriptorPath_4777659345280330855(thisNode)))) {
          int start = classesPath.indexOf(plugins) + plugins.length() + 1;
          int end = classesPath.indexOf(classes) - 1;
          if (start >= 0 && start < classesPath.length() && end >= 0 && end < classesPath.length() && start < end) {
            String pluginName = classesPath.substring(start, end);
            String pluginJar = classesPath.substring(0, start) + pluginName + Util.SEPARATOR + "lib" + Util.SEPARATOR + pluginName + ".jar";
            ListSequence.fromList(result).addElement(PathHolder_Behavior.createPathHolder_7235580512916878209(pluginJar, thisNode));
          }
        }
      }
    }


    return result;
  }

  public static List<SNode> call_getClassPathDirectories_1213877515083(SNode thisNode, boolean includeHomeLib) {
    AbstractModule module = (AbstractModule) Module_Behavior.call_getModule_1213877515148(thisNode);
    Collection<String> paths = Module_Behavior.call_getClassPathExcludingIdea_2000252915626233691(thisNode, module);
    return Module_Behavior.call_getPathHolders_4642981534832278885(thisNode, Sequence.fromIterable(Module_Behavior.call_convertSeparators_4777659345279794559(thisNode, CollectionSequence.fromCollection(((Collection<String>) paths)).toListSequence())).distinct().toListSequence(), true, includeHomeLib);
  }

  public static List<SNode> call_getModelRootPaths_2739262311775052381(SNode thisNode) {
    List<org.jetbrains.mps.openapi.persistence.ModelRoot> paths = ListSequence.fromListWithValues(new ArrayList<org.jetbrains.mps.openapi.persistence.ModelRoot>(), Module_Behavior.call_getModule_1213877515148(thisNode).getModelRoots());
    if (Module_Behavior.call_getModule_1213877515148(thisNode) instanceof Language) {
      ListSequence.fromList(paths).addSequence(Sequence.fromIterable(((Iterable<Generator>) ((Language) Module_Behavior.call_getModule_1213877515148(thisNode)).getGenerators())).translate(new ITranslator2<Generator, org.jetbrains.mps.openapi.persistence.ModelRoot>() {
        public Iterable<org.jetbrains.mps.openapi.persistence.ModelRoot> translate(Generator it) {
          return it.getModelRoots();
        }
      }));
    }
    paths = ListSequence.fromList(paths).where(new IWhereFilter<org.jetbrains.mps.openapi.persistence.ModelRoot>() {
      public boolean accept(org.jetbrains.mps.openapi.persistence.ModelRoot it) {
        return it instanceof DefaultModelRoot;
      }
    }).toListSequence();
    List<SNode> pathHolders = Module_Behavior.call_getPathHolders_1213877515000(thisNode, ListSequence.fromList(paths).translate(new ITranslator2<org.jetbrains.mps.openapi.persistence.ModelRoot, String>() {
      public Iterable<String> translate(org.jetbrains.mps.openapi.persistence.ModelRoot it) {
        Iterable<String> files = (((DefaultModelRoot) it)).getFiles(DefaultModelRoot.SOURCE_ROOTS);
        return Sequence.fromIterable(files).select(new ISelector<String, String>() {
          public String select(String it) {
            return it.replace(File.separator, Util.SEPARATOR);
          }
        });
      }
    }).distinct().toListSequence(), true);
    return ListSequence.fromList(pathHolders).sort(new ISelector<SNode, String>() {
      public String select(SNode it) {
        return SPropertyOperations.getString(it, "fullPath");
      }
    }, true).toListSequence();
  }

  public static List<SNode> call_getRuntimeClassPath_1213877515098(SNode thisNode, boolean includeRuntimeSolutions, boolean includeHomeLib) {
    IModule module = Module_Behavior.call_getModule_1213877515148(thisNode);
    if (module instanceof Language && includeRuntimeSolutions) {
      List<SNode> result = ListSequence.fromList(new ArrayList<SNode>());
      for (ModuleReference runtimeDependency : CollectionSequence.fromCollection(((Language) module).getRuntimeModulesReferences())) {
        IModule runtimeDependencyModule = MPSModuleRepository.getInstance().getModule(runtimeDependency);
        if (runtimeDependencyModule instanceof Solution) {
          // TODO proper module in holder? 
          ListSequence.fromList(result).addSequence(ListSequence.fromList(Module_Behavior.call_getPathHolders_1213877515000(thisNode, Sequence.fromIterable(Module_Behavior.call_convertSeparators_4777659345279794559(thisNode, Module_Behavior.call_getClassPathExcludingIdea_2000252915626233691(thisNode, (Solution) runtimeDependencyModule))).toListSequence(), true)));
        }
      }
      return result;
    }
    return new ArrayList<SNode>();
  }

  public static boolean call_needsSeparateFolder_1902360454496029008(SNode thisNode) {
    return ListSequence.fromList(Module_Behavior.call_getRuntimeClassPath_1213877515098(thisNode, false, false)).any(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SPropertyOperations.getString(it, "fullPath").endsWith(".jar");
      }
    }) || ListSequence.fromList(Module_Behavior.call_getClassPathDirectories_1213877515083(thisNode, false)).any(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SPropertyOperations.getString(it, "fullPath").endsWith(".jar");
      }
    });
  }

  public static List<SNode> call_getRequiredJars_1902360454496272739(SNode thisNode) {
    List<SNode> result = new ArrayList<SNode>();
    ListSequence.fromList(result).addSequence(ListSequence.fromList(Module_Behavior.call_getRuntimeClassPath_1213877515098(thisNode, false, false)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SPropertyOperations.getString(it, "fullPath").endsWith(".jar");
      }
    }));
    ListSequence.fromList(result).addSequence(ListSequence.fromList(Module_Behavior.call_getClassPathDirectories_1213877515083(thisNode, false)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SPropertyOperations.getString(it, "fullPath").endsWith(".jar");
      }
    }));
    return result;
  }

  public static String call_getModuleFolderPath_2850282874221203279(SNode thisNode) {
    return ModuleUtil.getRelativePath(AbstractProjectComponent_Behavior.call_getPath_1213877333777(thisNode).getPath(), AbstractProjectComponent_Behavior.call_getHomeFile_1213877333764(thisNode));
  }

  public static String call_getModuleSourcesJarPath_1986682148700597281(SNode thisNode) {
    if (Module_Behavior.call_needsSeparateFolder_1902360454496029008(thisNode)) {
      return Module_Behavior.call_getModuleFolderPath_2850282874221203279(thisNode) + Util.SEPARATOR + Module_Behavior.call_getModule_1213877515148(thisNode).getModuleFqName() + "-src.jar";
    }
    return Module_Behavior.call_getModuleFolderPath_2850282874221203279(thisNode) + "-src.jar";
  }

  public static String call_getRuntimeJarPath_1213877515126(SNode thisNode) {
    if (Module_Behavior.call_needsSeparateFolder_1902360454496029008(thisNode)) {
      return Module_Behavior.call_getModuleFolderPath_2850282874221203279(thisNode) + Util.SEPARATOR + Module_Behavior.call_getModule_1213877515148(thisNode).getModuleFqName() + "-runtime.jar";
    }
    return Module_Behavior.call_getModuleFolderPath_2850282874221203279(thisNode) + "-runtime.jar";
  }

  public static String call_getModuleJarPath_1213877515137(SNode thisNode) {
    if (Module_Behavior.call_needsSeparateFolder_1902360454496029008(thisNode)) {
      return Module_Behavior.call_getModuleFolderPath_2850282874221203279(thisNode) + Util.SEPARATOR + Module_Behavior.call_getModule_1213877515148(thisNode).getModuleFqName() + ".jar";
    }
    return Module_Behavior.call_getModuleFolderPath_2850282874221203279(thisNode) + ".jar";
  }

  public static IModule call_getModule_1213877515148(SNode thisNode) {
    return MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString(SPropertyOperations.getString(thisNode, "id")));
  }

  public static String call_getChildrenTargetDir_1213877514970(SNode thisNode) {
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(thisNode), "jetbrains.mps.build.packaging.structure.IAbstractCompositeComponent")) {
      return BehaviorReflection.invokeVirtual(String.class, SNodeOperations.cast(SNodeOperations.getParent(thisNode), "jetbrains.mps.build.packaging.structure.IAbstractCompositeComponent"), "virtual_getChildrenTargetDir_1237389224202", new Object[]{}) + File.separator + Module_Behavior.call_getTemporalDir_1213877514765(thisNode);
    }
    return Module_Behavior.call_getTemporalDir_1213877514765(thisNode);
  }

  public static String call_getModuleDescriptorPath_4777659345280330855(SNode thisNode) {
    return check_835h7m_a0a91(Module_Behavior.call_getModule_1213877515148(thisNode).getDescriptorFile().getParent().getPath(), File.separator, Util.SEPARATOR);
  }

  public static String call_getHomeLibPath_4642981534832311125(SNode thisNode) {
    String path = PathManager.getHomePath() + "/lib";
    return path.replace(File.separator, Util.SEPARATOR);
  }

  public static List<SNode> call_getPathHolders_1213877515000(SNode thisNode, List<String> stubpath, boolean onlyUnderModuleBasedir) {
    return Module_Behavior.call_getPathHolders_4642981534832278885(thisNode, stubpath, onlyUnderModuleBasedir, false);
  }

  public static List<SNode> call_getPathHolders_4642981534832278885(SNode thisNode, List<String> stubpath, boolean onlyUnderModuleBasedir, boolean includeLibJars) {
    List<SNode> result = new ArrayList<SNode>();
    String moduleBasedir = "";
    String homeLib = "";
    // search for project if needed 
    if (onlyUnderModuleBasedir) {
      moduleBasedir = Module_Behavior.call_getModuleDescriptorPath_4777659345280330855(thisNode);
    }
    if (includeLibJars) {
      homeLib = Module_Behavior.call_getHomeLibPath_4642981534832311125(thisNode);
    }
    // process classpath 
    for (String cp : ListSequence.fromList(stubpath)) {
      if ((!(onlyUnderModuleBasedir) || cp.startsWith(moduleBasedir)) || (includeLibJars && cp.startsWith(homeLib))) {
        ListSequence.fromList(result).addElement(PathHolder_Behavior.createPathHolder_7235580512916878209(cp, thisNode));
      }
    }
    return result;
  }

  public static Iterable<String> call_convertSeparators_4777659345279794559(SNode thisNode, Iterable<String> paths) {
    return Sequence.fromIterable(paths).select(new ISelector<String, String>() {
      public String select(String it) {
        return it.replace(File.separator, Util.SEPARATOR);
      }
    });
  }

  public static Collection<String> call_getClassPathExcludingIdea_2000252915626233691(SNode thisNode, AbstractModule module) {
    return (module.isCompileInMPS() ?
      module.getClassPath() :
      module.getAdditionalClassPath()
    );
  }

  public static boolean virtual_acceptFiles_1262430001741497846(SConcept thisConcept) {
    return true;
  }

  public static List<IModule> getAllAvailableModules_1222444746697() {
    List<IModule> list = ListSequence.fromList(new ArrayList<IModule>());
    for (Language language : CollectionSequence.fromCollection(GlobalScope.getInstance().getVisibleLanguages())) {
      ListSequence.fromList(list).addElement(language);
    }
    for (DevKit devKit : CollectionSequence.fromCollection(GlobalScope.getInstance().getVisibleDevkits())) {
      ListSequence.fromList(list).addElement(devKit);
    }
    for (Solution solution : CollectionSequence.fromCollection(GlobalScope.getInstance().getVisibleSolutions())) {
      ListSequence.fromList(list).addElement(solution);
    }
    return list;
  }

  public static String extractModuleProperName_1235487584035(IModule module) {
    return Module_Behavior.replaceBadCharacters_1235487831795(module.getModuleFqName());
  }

  public static String replaceBadCharacters_1235487831795(String name) {
    return name.replace("/", "_").replace("\\", "_");
  }

  private static String check_835h7m_a0a91(String checkedDotOperand, String separator, String SEPARATOR) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.replace(File.separator, Util.SEPARATOR);
    }
    return null;
  }
}

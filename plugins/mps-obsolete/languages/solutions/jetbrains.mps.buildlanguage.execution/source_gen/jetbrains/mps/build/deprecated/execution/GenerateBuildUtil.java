package jetbrains.mps.build.deprecated.execution;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import java.io.File;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.project.Project;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.ide.generator.GeneratorUIFacade;
import jetbrains.mps.project.ProjectOperationContext;
import jetbrains.mps.ide.project.ProjectHelper;
import java.util.ArrayList;
import jetbrains.mps.generator.GenerationFacade;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.progress.EmptyProgressMonitor;
import jetbrains.mps.ide.messages.DefaultMessageHandler;
import jetbrains.mps.generator.GenerationOptions;
import jetbrains.mps.ide.generator.TransientModelsComponent;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.application.ModalityState;

public class GenerateBuildUtil {
  public GenerateBuildUtil() {
  }

  public static String getFolderToGenerateInto(final SNode configuration) {
    final Wrappers._T<String> folder = new Wrappers._T<String>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        folder.value = BehaviorReflection.invokeNonVirtual(String.class, BehaviorReflection.invokeNonVirtual((Class<SNode>) ((Class) Object.class), configuration, "jetbrains.mps.build.packaging.structure.Configuration", "call_getLayout_1213877261819", new Object[]{}), "jetbrains.mps.build.packaging.structure.Layout", "call_getFolderToGenerate_1229522949966", new Object[]{});
      }
    });
    return folder.value;
  }

  public static String getGeneratedFilePath(final SNode configuration) {
    final Wrappers._T<String> fileName = new Wrappers._T<String>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        fileName.value = BehaviorReflection.invokeNonVirtual(String.class, BehaviorReflection.invokeNonVirtual((Class<SNode>) ((Class) Object.class), configuration, "jetbrains.mps.build.packaging.structure.Configuration", "call_getLayout_1213877261819", new Object[]{}), "jetbrains.mps.build.packaging.structure.Layout", "call_getFolderToGenerate_1229522949966", new Object[]{}) + File.separator + BehaviorReflection.invokeNonVirtual(String.class, configuration, "jetbrains.mps.build.packaging.structure.Configuration", "call_getBuildFileName_1230217425313", new Object[]{}) + ".xml";
      }
    });
    return fileName.value;
  }

  public static SNode getLayout(final SModelDescriptor descriptor) {
    final Wrappers._T<SNode> layout = new Wrappers._T<SNode>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        SModel model = descriptor.getSModel();
        layout.value = ListSequence.fromList(SModelOperations.getRoots(model, "jetbrains.mps.build.packaging.structure.Layout")).first();
      }
    });
    return layout.value;
  }

  public static boolean generate(@NotNull final SNode layout, @NotNull final Project project, final boolean showWindow) {
    final Wrappers._T<String> baseFolder = new Wrappers._T<String>();
    final Wrappers._T<SModelDescriptor> descriptor = new Wrappers._T<SModelDescriptor>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        baseFolder.value = BehaviorReflection.invokeNonVirtual(String.class, layout, "jetbrains.mps.build.packaging.structure.Layout", "call_getFolderToGenerate_1229522949966", new Object[]{});
        descriptor.value = SNodeOperations.getModel(layout).getModelDescriptor();
      }
    });

    final Wrappers._boolean result = new Wrappers._boolean();
    final _FunctionTypes._void_P0_E0 generate = new _FunctionTypes._void_P0_E0() {
      public void invoke() {
        if (false && showWindow) {
          result.value = GeneratorUIFacade.getInstance().generateModels(new ProjectOperationContext(ProjectHelper.toMPSProject(project)), ListSequence.fromListAndArray(new ArrayList<SModelDescriptor>(), descriptor.value), new BuildGenerationHandler(baseFolder.value), true, true);
        } else {
          result.value = GenerationFacade.generateModels(project.getComponent(MPSProject.class), ListSequence.fromListAndArray(new ArrayList<SModelDescriptor>(), descriptor.value), new ProjectOperationContext(ProjectHelper.toMPSProject(project)), new BuildGenerationHandler(baseFolder.value), new EmptyProgressMonitor(), new DefaultMessageHandler(project), GenerationOptions.getDefaults().create(), project.getComponent(TransientModelsComponent.class));
        }
      }
    };
    if (ApplicationManager.getApplication().isDispatchThread()) {
      generate.invoke();
    } else {
      ApplicationManager.getApplication().invokeAndWait(new Runnable() {
        @Override
        public void run() {
          generate.invoke();
        }
      }, ModalityState.NON_MODAL);
    }
    return result.value;
  }
}

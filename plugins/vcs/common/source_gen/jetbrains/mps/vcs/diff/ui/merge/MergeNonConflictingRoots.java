package jetbrains.mps.vcs.diff.ui.merge;

/*Generated by MPS */

import jetbrains.mps.workbench.action.BaseAction;
import com.intellij.openapi.project.DumbAware;
import com.intellij.openapi.actionSystem.AnActionEvent;
import java.util.Map;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.vcs.diff.changes.MetadataChange;

public class MergeNonConflictingRoots extends BaseAction implements DumbAware {
  private MergeModelsDialog myDialog;

  public MergeNonConflictingRoots(MergeModelsDialog dialog) {
    super("Automatically Merge Non-Conflicting Roots", null, MergeModelsDialog.APPLY_NON_CONFLICTS);
    myDialog = dialog;
    setDisableOnNoProject(false);
  }

  protected void doExecute(AnActionEvent event, Map<String, Object> map) {
    Iterable<ModelChange> changes = getChanges();
    myDialog.getMergeSession().applyChanges(changes);
    myDialog.markMetadataChangesAsApplied(Sequence.fromIterable(changes).where(new IWhereFilter<ModelChange>() {
      public boolean accept(ModelChange ch) {
        return ch instanceof MetadataChange;
      }
    }));
    myDialog.rebuildLater();
  }

  @Override
  protected void doUpdate(AnActionEvent event, Map<String, Object> map) {
    event.getPresentation().setEnabled(Sequence.fromIterable(getChanges()).isNotEmpty());
  }

  private Iterable<ModelChange> getChanges() {
    return myDialog.getMergeSession().getApplicableChangesInNonConflictingRoots();
  }
}

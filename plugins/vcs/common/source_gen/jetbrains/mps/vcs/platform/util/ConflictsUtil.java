package jetbrains.mps.vcs.platform.util;

/*Generated by MPS */

import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;
import com.intellij.openapi.project.Project;
import org.jetbrains.annotations.Nullable;
import com.intellij.openapi.vfs.VirtualFile;
import jetbrains.mps.smodel.SModelDescriptor;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.DefaultSModelDescriptor;
import jetbrains.mps.ide.vfs.VirtualFileUtils;
import com.intellij.openapi.vcs.FileStatus;
import com.intellij.openapi.vcs.FileStatusManager;
import jetbrains.mps.project.IModule;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.vfs.IFile;

public class ConflictsUtil {
  public ConflictsUtil() {
  }

  public static boolean isModelOrModuleConflicting(EditableSModelDescriptor emd, Project project) {
    return getModelFileIfConflicting(emd, project) != null || getModuleFileIfConflicting((emd != null ?
      emd.getModule() :
      null
    ), project) != null;
  }

  @Nullable
  public static VirtualFile getModelFileIfConflicting(@Nullable SModelDescriptor md, @NotNull Project project) {
    if (md instanceof DefaultSModelDescriptor) {
      VirtualFile vf = VirtualFileUtils.getVirtualFile(((DefaultSModelDescriptor) md).getSource().getFile());
      if (vf != null) {
        FileStatus status = FileStatusManager.getInstance(project).getStatus(vf);
        if (FileStatus.MERGED_WITH_CONFLICTS == status || FileStatus.MERGED_WITH_BOTH_CONFLICTS == status) {
          return vf;
        }
      }
    }
    return null;
  }

  @Nullable
  public static VirtualFile getModuleFileIfConflicting(@Nullable IModule module, @NotNull Project project) {
    if (module instanceof Generator) {
      module = ((Generator) module).getSourceLanguage();
    }
    VirtualFile vf = VirtualFileUtils.getVirtualFile(check_h51169_a0a1a2(module));
    if (vf != null) {
      FileStatus status = FileStatusManager.getInstance(project).getStatus(vf);
      if (FileStatus.MERGED_WITH_CONFLICTS == status || FileStatus.MERGED_WITH_BOTH_CONFLICTS == status) {
        return vf;
      }
    }
    return null;
  }

  private static IFile check_h51169_a0a1a2(IModule checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getDescriptorFile();
    }
    return null;
  }
}

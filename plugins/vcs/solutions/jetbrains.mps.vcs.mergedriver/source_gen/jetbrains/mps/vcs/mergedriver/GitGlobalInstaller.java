package jetbrains.mps.vcs.mergedriver;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import com.intellij.openapi.project.Project;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.workbench.WorkbenchPathManager;
import java.io.File;
import com.intellij.openapi.ui.Messages;
import java.util.List;
import jetbrains.mps.util.StringsIO;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import java.io.IOException;

/*package*/ class GitGlobalInstaller extends AbstractInstaller {
  protected static Log log = LogFactory.getLog(GitGlobalInstaller.class);

  public GitGlobalInstaller(Project project) {
    super(project);
  }

  @NotNull
  protected AbstractInstaller.State install(boolean dryRun) {
    String globalConfigPath = WorkbenchPathManager.getUserHome() + File.separator + ".gitconfig";
    File configFile = new File(globalConfigPath);
    if (!(configFile.exists())) {
      if (!(dryRun)) {
        Messages.showErrorDialog(myProject, "Git config (~/.gitconfig) file is not present", "No Git Config");
      }
      return AbstractInstaller.State.NOT_INSTALLED;
    }

    List<String> configLines = StringsIO.readLines(configFile);
    if (ListSequence.fromList(configLines).any(new IWhereFilter<String>() {
      public boolean accept(String line) {
        return line.matches("\\s*\\[merge\\s+\"mps\"\\]\\s*");
      }
    })) {
      // TODO check if outdated 
      return AbstractInstaller.State.INSTALLED;
    }

    if (dryRun) {
      return AbstractInstaller.State.NOT_INSTALLED;
    }

    ListSequence.fromList(configLines).addElement("");
    ListSequence.fromList(configLines).addElement("[merge \"mps\"]");
    ListSequence.fromList(configLines).addElement("\tname = MPS merge driver");
    String cmd = MergeDriverMain.getCommandLine().replace("\\", "\\\\");
    ListSequence.fromList(configLines).addElement(String.format("\tdriver = %s --git %%O %%A %%B %%L", cmd));
    ListSequence.fromList(configLines).addElement("");

    try {
      StringsIO.writeLines(configFile, configLines);
      Messages.showInfoMessage(myProject, "Successfully updated ~/.gitconfig", "Global Git Merge Driver Installed");
      return AbstractInstaller.State.INSTALLED;
    } catch (IOException e) {
      if (log.isErrorEnabled()) {
        log.error("Writing gitconfig file failed", e);
      }
      Messages.showErrorDialog(myProject, "Writing gitconfig file failed (" + e.getMessage() + ")", "Writing .gitconfig Failed");
      return AbstractInstaller.State.NOT_INSTALLED;
    }
  }
}

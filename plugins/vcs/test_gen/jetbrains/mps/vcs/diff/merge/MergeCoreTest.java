package jetbrains.mps.vcs.diff.merge;

/*Generated by MPS */

import org.junit.runner.RunWith;
import jetbrains.mps.testbench.junit.runners.FilepathParameterized;
import java.io.File;
import org.junit.Test;
import org.junit.Assert;
import org.junit.runners.Parameterized;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.ISelector;
import org.junit.BeforeClass;
import jetbrains.mps.MPSCore;
import java.util.Properties;
import org.apache.log4j.PropertyConfigurator;
import org.junit.AfterClass;
import java.io.IOException;
import jetbrains.mps.smodel.persistence.def.ModelReadException;
import jetbrains.mps.internal.collections.runtime.ListSequence;

@RunWith(value = FilepathParameterized.class)
public class MergeCoreTest {
  private static final File TESTDATA_HOME = new File("testbench/modules/merge");
  private static String ourPlayRefactoringWas;
  private static boolean ourMergeDriverModeWas;
  private static final String PLAY_REFACTORINGS_PROPERTY = "mps.playRefactorings";
  private String myZipName;

  public MergeCoreTest(String testName, String zipName) {
    myZipName = zipName;
  }

  @Test
  public void testMerge() {
    try {
      Assert.assertTrue(new MergeData(new File(TESTDATA_HOME, myZipName)).check());
    } catch (Exception e) {
      e.printStackTrace();
      Assert.fail();
    }
  }

  @Parameterized.Parameters
  public static List<Object[]> params() {
    return Sequence.fromIterable(Sequence.fromArray(TESTDATA_HOME.list())).where(new IWhereFilter<String>() {
      public boolean accept(String n) {
        return n.endsWith(".mps.zip");
      }
    }).sort(new ISelector<String, String>() {
      public String select(String n) {
        return n;
      }
    }, true).select(new ISelector<String, Object[]>() {
      public Object[] select(String n) {
        return new Object[]{n.replaceAll("\\.|-", "_"), n};
      }
    }).toListSequence();
  }

  @BeforeClass
  public static void setUpClass() {
    ourPlayRefactoringWas = System.getProperty(PLAY_REFACTORINGS_PROPERTY);
    ourMergeDriverModeWas = MPSCore.getInstance().isMergeDriverMode();

    System.setProperty(PLAY_REFACTORINGS_PROPERTY, "false");
    MPSCore.getInstance().setMergeDriverMode(true);

    Properties p = new Properties();
    p.setProperty("log4j.rootLogger", "info, console");
    p.setProperty("log4j.appender.console", "org.apache.log4j.ConsoleAppender");
    p.setProperty("log4j.appender.console.layout", "org.apache.log4j.PatternLayout");
    p.setProperty("log4j.appender.console.layout.ConversionPattern", "%-4r [%t] %-5p %c %x - %m%n");
    p.setProperty("log4j.appender.console.target", "System.err");
    PropertyConfigurator.configure(p);
  }

  @AfterClass
  public static void tearDownClass() {
    if (ourPlayRefactoringWas == null) {
      System.getProperties().remove(PLAY_REFACTORINGS_PROPERTY);
    } else {
      System.setProperty(PLAY_REFACTORINGS_PROPERTY, ourPlayRefactoringWas);
    }
    MPSCore.getInstance().setMergeDriverMode(ourMergeDriverModeWas);
  }

  public static void main(String[] args) throws IOException, ModelReadException {
    setUpClass();
    for (Object[] p : ListSequence.fromList(params())) {
      new MergeData(new File(TESTDATA_HOME, (String) p[1])).generate();
    }
  }
}
